---
title: "Analyse de l'utilisation des vélos libre-service à Washington"
author: "Julien Schieler, Icham Lecorvaisier, Mathis Reslinger, Lila Mortier"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

# Analyse de l’utilisation des vélos libre-service à Washington

Julien Schieler, Icham Lecorvaisier, Mathis Reslinger, Lila Mortier

## Introduction

Ce rapport présente une analyse approfondie de l'utilisation des vélos libre-service à Washington, en exploitant quatre jeux de données pour identifier les tendances d'usage, les comportements des usagers et les facteurs influençant l'utilisation du service, afin de fournir des insights pertinents pour les décideurs publics et les acteurs de la mobilité durable.

### Données

Nous utilisons 4 jeux de données pour analyser l’utilisation des vélos libre-service à Washington :

**Information sur les locations de vélos** (source :<https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv>)

-   **Nom du dataset :** daily_rent_detail.csv
-   **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre service de Washington.
-   **Pourquoi ces données ?** Elles permettent d’observer l’utilisation de ces vélos, en analysant les dates et heures d’utilisation, les lieux d’emprunt et de dépôt notamment.
-   **Nombre d’observations** : 16 086 673
-   **Nombre de colonnes** : 13 colonnes incluant :
    -   Identifiant du trajet (”ride_id”)
    -   Type du vélo (”rideable type”) : vélo classique, électrique, autre (cargo)
    -   Date et heure de l’emprunt (”started_at”)
    -   Date et heure du retour (”ended_at”)
    -   Nom de la station de départ (”start_station_name”)
    -   Identifiant de la station de départ (”start_station_id)
    -   Nom de la station d’arrivée (”end_station_name”)
    -   Identifiant de la station d’arrivée (”end_station_id”)
    -   Latitude de départ (”start_lat”)
    -   Longitude de départ (”start_lng”)
    -   Latitude d’arrivée (”end_lat”)
    -   Longitude d’arrivée (”end_lng”)
    -   Type d’abonnement du client (”member_casual”) : utilisateur en abonnement casual ou membre.
-   **Créateur et éditeur** : Entreprise Capital Bike Share
-   **Format** : CSV
-   **Sous-groupes** :
    -   Type de vélo : vélo classique, électrique et cargo
    -   Type d’utilisateur : occasionnel et membre
    -   Stations : possibilité d’analyser par station d’origine ou de destination
    -   Périodes temporelles : heures, jours, saisons, etc…

**Liste des stations de Washington** (source :<https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv>)

-   **Nom du dataset :** station_list.csv
-   **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre-service de Washington.
-   **Pourquoi ces données ?** Elles permettent d’avoir la liste des stations à Washington
-   **Nombre d’observations :** 912 stations différentes
-   **Nombre de colonnes :** 2 colonnes incluant **:**
    -   Nom de la station
    -   Identifiant de la station
-   **Format :** CSV
-   **Sous-groupes** :
    -   Catégorisation géographique (ex: quartiers)

**Emprunts et dépôts des vélos par station** (source :<https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv>)

-   **Nom du dataset :** usage_frequency.csv
-   **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre-service de Washington.
-   **Pourquoi ces données ?** Elles permettent d’avoir le nombre d’emprunt et de dépôt pour chaque station à Washington
-   **Nombre d’observations :** 873 318
-   **Nombre de colonnes :** 4 colonnes incluant **:**
    -   Date
    -   Nom de la station
    -   Nombre d’emprunt sur cette station
    -   Nombre de dépôt sur cette station
-   **Format :** CSV
-   **Sous-groupes** :
    -   Date
    -   Stations : possibilité d’analyser par stations
    -   Activité : Emprunt et dépôt
    -   Utilisation : stations très utilisées et peu utilisées

**Météo (source :** <https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=weather.csv>)

-   **Nom du dataset :** weather.csv
-   **Origine des données** : Ces données proviennent de l’entreprise Visual Crossing qui est un service de météo de Virginia aux Etats Unis.
-   **Pourquoi ces données ?** Elles permettent d’obtenir la météo de chaque jour afin de pouvoir croiser ces données avec l’utilisation des vélos à Washington
-   **Nombre d’observations :** 1584, une pour chaque jour entre mai 2020 et août 2024
-   **Nombre de colonnes :** 32 colonnes dont 7 que nous allons utiliser **:**
    -   Date (”*datetime”*)
    -   Moyenne de température sur la journée (”*temp*”)
    -   Moyenne de température ressentie sur la journée (”*feelslike*”)
    -   Précipitations (”*precip*”) : quantité de liquide tombé / prévu dans la période
    -   Epaisseur de neige au sol (”*snowdepth*”)
    -   Couverture nuageuse (”*cloudcover*”) : entre 0 et 100%
    -   Vitesse du vent (”*windspeed*”) : vitesse moyenne du vent soutenu, mesurée comme la vitesse moyenne du vent survenant au cours de la à deux minutes précédentes
-   **Créateur et éditeur** : Visual Crossing (fournisseur de données météorologiques)
-   **Format :** CSV
-   **Sous-groupes** :
    -   Conditions météorologiques : pluie, neige, vent, etc…
    -   Températures : froid, tempéré, chaud
    -   Saisons : printemps, été, automne, hiver
    -   Jours : semaine ou week-end

### Plan d’analyse

Avant de commencer l'analyse, nous nous posons plusieurs questions que l’on peut catégoriser :

1.  Utilisation générale des vélos

-   Combien de trajets sont effectués en moyenne par jour/mois ? **Graphique :** barplot du nombre de trajets par jour de la semaine, par mois de l’année\
    **Variables :** Nombre de trajets, date d’emprunt
-   Quelle est la tendance générale de l’utilisation des vélos au cours de l’année ? Y a-t-il des pics saisonniers ?\
    **Graphique :** Lineplot du nombre de trajet en fonction du temps\
    **Variables :** Nombre de trajets, date
-   Quelles sont les durées moyenne des trajets ? Varient-elles selon le jour de la semaine ou le type d'utilisateur ?\
    **Graphique :** Boxplot ou violin plot\
    **Variables :** Durée du trajet, type d’utilisateur, date
-   Quel type de vélo (électrique, classique ou cargo) est le plus utilisé ? Varie-t-il en fonction du type d'utilisateur ? \
    **Graphique :** Barchart avec pourcentage/nombre de vélos par catégorie\
    **Variables :** Type de vélo, Nombre de trajets par type de vélos, type d'utilisateur
-   Selon les saisons, la fréquence de cyclistes occasionnels change-t-elle comparé aux membres ?\
    **Graphique :** Lineplot par type d’utilisateur\
    **Variables :** nombre de trajets, type d’utilisateurs, mois
-   En se focalisant sur les utilisateurs, y a-t-il des effets “heures de pointe” dans la journée ?\
    **Graphique :** Lineplot (heure en abscisse et nombre de trajets en ordonnée)\
    **Variables :** nombre de trajets, heure

2.  Utilisation des stations

-   Quelles stations sont les plus utilisées pour les départs/arrivées ?\
    **Graphique :** Carte avec points de taille différentes pour le nombre de départs/arrivées\
    **Variables :** Nom des stations, Nombre de départs/arrivées, Coordonnées des stations
-   Quelles stations sont les plus actives à différentes périodes de la journée (matin ou soir) ?\
    **Graphique :** Heatmap avec X= heure, Y = station et couleur = nombre de trajets\
    **Variables :** Heure, Nom de la station, Nombre de trajets
-   Quelles sont les stations les plus utilisées le week-end, en semaine ?\
    **Graphique :** Stacked barplot\
    **Variables :** Jour de la semaine, nom station, nombre de trajets
-   Existe-t-il des stations avec un fort déséquilibre entre départs et arrivées ?\
    **Graphique :** Barplot (différence départ, arrivée)\
    **Variables :** Nom de la station, Nombre de départs/arrivées
-   Quels sont les trajets les plus fréquents (station de départ vers station d’arrivée) ?\
    **Graphique :** Barplot (top 10 des paires de stations les plus fréquentées)\
    **Variables :** Nom de la station de départ, Nom de la station d’arrivée, Nombre de trajets

3.  Lien avec la météo

-   Comment la météo influence-t-elle l’usage des vélos ?
    (pluie, température, vent, etc…)\
    **Graphique :** Lineplot ou scatterplot par variable météorologique\
    **Variables :** Conditions météo, Nombre de trajet par jour

-   Quel est l’impact des conditions météorologiques sur la durée moyenne des trajets ?\
    **Graphique :** Lineplot ou scatterplot par variable météorologique\
    **Variables :** Conditions météo, Durée moyenne des trajets

-   En cas de météo extrême (fortes pluies ou froid extrême), est-ce que le volume de trajets diminue fortement ?\
    **Graphique :** Boxplot (jours normaux vs météo extrême)\
    **Variables :** Conditions météo, nombre de trajets

-   Les membres abonnés utilisent-ils plus les vélos que les usagers occasionnels quand il fait mauvais ?\
    **Graphique :** Lineplot avec comparaison entre les types d’utilisateur\
    **Variables :** météo, nombre de trajet, type d’utilisateur

4.  Question bonus

-   Est ce qu’il est possible de voir une différence d’utilisation des vélos lors de la prise du Capitol le 6 janvier 2021?\
    **Graphique :** Lineplot (date en abscisse, nombre de trajets en ordonnée, avec mise en évidence du 6 janvier 2021)\
    **Variables :** Date de début du trajet, Nombre de trajets par jour

### Contraintes et limites :

-   **Données agrégées** : L'absence d’identifiant unique pour chaque vélo limite les possibilités de reconstitution précise des itinéraires ou des distances parcourues.
-   **Données contextuelles limitées** : Les événements exceptionnels (grèves, manifestations, travaux, etc.) ou les changements d’infrastructure (nouvelles pistes cyclables, réaménagements urbains) ne sont pas pris en compte dans les données disponibles.
-   **Intention de l’usager** : bien qu’il soit riche en information, les jeux de données ne reflète pas nécessairement les raisons des choix des usagers (par ex: s’il n’y a plus de vélos électriques disponibles, l’usager va être contraint de prendre un vélo classique contre son gré)

L’objectif est d’aboutir à une compréhension approfondie de la pratique du cyclisme à Washington à partir de ces jeux de données, en identifiant les tendances d’usage, les comportements des usagers, et les facteurs (comme la météo ou la localisation des stations) influençant l’utilisation du service.
Cette analyse vise à fournir des insights pertinents pour les décideurs publics, les urbanistes, les acteurs de la mobilité durable, ainsi que pour les citoyens investis dans l’amélioration des mobilités douces.

### Importation du jeu de données et des librairies

```{r Importation_Packages, echo=FALSE, include=FALSE}
library(readr);
library(leaflet);
library(ggplot2); 
library(dplyr); 
library(lubridate);
require('utils');
library(RColorBrewer);
library(forcats);
library(stringr);
options(ggplot2.discrete.fill = RColorBrewer::brewer.pal(4, "Set2"))
options(ggplot2.continous.fill = RColorBrewer::brewer.pal(4, "PuBu"))
my_colors <- RColorBrewer::brewer.pal(8, "Set2") 

update_geom_defaults("point", list(color = my_colors[1]))
update_geom_defaults("line", list(color = my_colors[2]))
update_geom_defaults("bar", list(fill = my_colors[3]))
```

```{r}
#importation du jeu de données
df <- read_csv("data/daily_rent_detail.csv")
weather <- read_csv("data/weather.csv")
df_usage <- read_csv("data/usage_frequency.csv")
```

# Utilisation générale des vélos 

### Question 1

#### Question 1a : Y a-t-il une variation du nombre de trajets selon les jours de la semaine ?

**Traitement des données pour les questions 1a et 1b** :

Pour cette analyse, nous avons choisi de ne conserver que la variable started_at, qui indique le moment précis où chaque vélo a été emprunté.
À partir de cette information temporelle, nous avons dérivé d’autres variables selon les questions que nous souhaitions étudier :

-   Pour la question 1a, nous avons utilisé la fonction wday() du package lubridate afin d’extraire le jour de la semaine correspondant à chaque date.
-   Pour la question 1b, nous avons extrait le mois grâce à la fonction month().

Ces transformations nous ont permis de comprendre l’évolution du nombre d’emprunts selon les moments de la semaine ou de l’année.

**Hypothèse** :

Nous imaginons que les utilisateurs empruntent davantage les vélos en semaine (pour se rendre au travail notamment) que le week-end.

**Graphique** :

```{r}
# Préparation des données
avg_rides_per_day <- df %>%
  transmute(
    day_of_week = wday(started_at, label = TRUE, abbr = FALSE, week_start = 1),
    date = as_date(started_at)
  ) %>%
  # on garde la date et le jour correspondant
  group_by(date, day_of_week) %>%
  # un groupe = une date unique avec son jour
  summarise(daily_count = n(), .groups = "drop") %>%
  group_by(day_of_week) %>%
  summarise(avg_per_day = mean(daily_count))%>%

# Visualisation
avg_rides_per_day %>%
  ggplot(aes(x = day_of_week, y = avg_per_day)) +
  geom_col(fill = "blue") +
  labs(
    title = "Nombre moyen de trajets par jour de la semaine",
    x = "Jour de la semaine",
    y = "Nombre moyen de trajets"
  ) + 
  scale_y_continuous(breaks = seq(6000, 12000, by = 1000)) +
  coord_cartesian(ylim = c(6000, NA)) + 
  # Limite inférieure à 6000    
  theme_minimal()
```

**Interprétation** :

Contrairement à notre hypothèse initiale, les week-ends enregistrent en réalité un nombre très élevé de trajets, en particulier le samedi qui dépasse tous les autres jours de la semaine.
Cela suggère que l’usage du vélo ne se limite pas à une fonction utilitaire (travail), mais qu’il est aussi très utilisé pour les loisirs.
Le dimanche reste élevé, presque équivalent aux jours de travail.

En semaine, le nombre de trajets reste relativement stable autour de 10 000 trajets par jour.
Cependant, on observe une baisse notable le lundi, où la moyenne descend à environ 9 000 trajets.
Cela peut s’expliquer par le fait que de nombreux commerces, établissements culturels ou services (comme les banques) sont souvent fermés le lundi, ce qui réduit potentiellement le besoin de déplacement.

Cette observation sera affinée par une analyse horaire (Les pics du matin et du soir existent-ils en semaine ?) dans la suite de notre étude.
On peut également effectuer une analyse des catégories d'usagers (membres ou occasionnels).

**Hypothèse :**

On peut s'attendre à ce que les utilisateurs 'casual' utilisent plus le weekend.

**Graphique**

```{r}

df_day_user <- df %>%
  mutate(
    started_at = ymd_hms(started_at),
    ended_at = ymd_hms(ended_at),
    ride_duration = as.numeric(difftime(ended_at, started_at, units = "mins"))
  ) %>%
  filter(ride_duration > 0 & ride_duration < 1440) 

df_day_user %>% mutate(day_of_week = wday(started_at, label = TRUE)) %>% 
  count(member_casual, day_of_week) %>% 
  ggplot(aes(x = day_of_week, y = n, fill = member_casual)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  labs( title = "Utilisation selon le jour de la semaine", x = "Jour", y = "Nombre de trajets", fill = "Utilisateur" ) + 
  theme_minimal()
```

**Interprétation**

On peut voir sur le graphique que les utilisateurs casuals font plus de trajets le weekend tandis que les utilisateurs members font plus de trajets la semaine.
Ces résultats sont sûrement dûs au fait que les utilisateurs casual utilisent les vélos pour le loisir pour faire des balades le weekend, tandis que les members les utilisent la semaine pour aller travailler, aller à l'école...
Cela confirme donc nos hypothèses initiales

#### Question 1b : Y a-t-il une variation du nombre de trajets selon les mois de l’année ?

**Hypothèse** :

Nous supposons que la fréquentation des vélos est plus importante en été, en raison du beau temps, et qu’elle diminue pendant les mois froids et pluvieux.

**Graphique** :

```{r} 
# Préparation des données
avg_rides_per_month <- df %>%
  transmute(months = month(started_at, label = TRUE, abbr = FALSE), date = as_date(started_at)) %>%
  # on garde la date et le mois correspondant   
  group_by(date, months) %>% 
  # un groupe = une date unique avec son mois   
  summarise(monthly_count = n(), .groups = "drop") %>%
  group_by(months) %>% 
  summarise(avg_per_month = mean(monthly_count))%>%  

  # Visualisation avg_rides_per_month %>%   
avg_rides_per_month %>%   
  ggplot(aes(x = months, y = avg_per_month)) +  # Le pipe %>% était manquant
  geom_col(fill = "blue") +  
  labs(title = "Nombre moyen de trajets par mois de l'année",
       x = "Mois", 
       y = "Nombre moyen de trajets") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Interprétation** :

Le nombre moyen de trajets évolue clairement au rythme des saisons.

L’activité augmente fortement entre avril et septembre, avec un pic en juillet-août où l'on atteint près de 13 000 trajets en moyenne.
Cette hausse s’explique sans doute par les vacances estivales et des conditions météorologiques plus favorables.

À l'inverse, les trajets diminuent nettement en hiver, notamment entre décembre et février, où le nombre moyen redescend autour de 5 000 trajets en décembre.
Cette baisse reflète un usage moindre du vélo durant les mois les plus froids de l'année.

## Question 2 : Quelle est la tendance générale de l'utilisation des vélos au cours de l'année ? 

**Hypothèse** :

En premier lieu, une observation intéressante à faire est d’observer la tendance générale de l’utilisation des vélos au cours des années étudiées.
Nous pouvons imaginer une corrélation avec la température pour représenter les saisons, et l’utilisation des vélos.

**Graphique** :

```{r}
#Préparation des données
# Nombre trajets par semaine
df$date <- as.Date(df$started_at)

df_semaine <- df %>%
  mutate(semaine = floor_date(date, "week", week_start = 1)) %>%
  group_by(semaine) %>%
  summarise(nombre_trajets_semaine = sum(n()))

#Température moyenne par semaine
weather_semaine <- weather %>%#
  mutate(semaine = floor_date(datetime, "week", week_start = 1)) %>%
  group_by(semaine) %>%
  summarise(temp = mean(temp, na.rm = TRUE))

#Facteur d'agrandissement Nombre trajet / Température
facteur_trajet_temperature <- max(df_semaine$nombre_trajets_semaine, na.rm = TRUE) / max(weather_semaine$temp, na.rm = TRUE)

# Visualisation
ggplot() +
  geom_line(data = df_semaine,
            aes(x = semaine, y = nombre_trajets_semaine),
            color = "black") +
  geom_smooth(data = weather_semaine,
              aes(x = semaine, y = temp * facteur_trajet_temperature),
              color = "lightcoral",
              method = "loess",
              span= 0.2,) +
  scale_y_continuous(
    name = "Nombre de trajets",
    sec.axis = sec_axis(~ . / facteur_trajet_temperature, name = "Température (°C)") ) +
  labs(title = "Nombre de trajets par semaine et température",
       x = "Date",
       subtitle = "Trajets (noir) et température (rouge)") +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title.y.right = element_text(color = "red")
  )
```

**Interprétation** :

Nous constatons une augmentation au fil des années de l’utilisation des vélos et surtout une cyclicité.
Nous observons une corrélation très forte entre la température et l’utilisation des vélos.
Les utilisateurs privilégient l’utilisation des vélos lors de températures chaudes.
Ainsi, nous pouvons voir que les utilisations majoritaires se font pendant le printemps, l’été et l’automne.

Certaines semaines ne suivent pas le paterne comme la semaine du 3 janvier 2022.
Avec une température moyenne de 0°, l’utilisation du vélo est la plus faible du dataset avec 15 083 utilisations.
Ceci peut s’expliquer par une chute de neige tombée le 3 janvier où 17,5 cm sont tombés en une journée.
On observe des phénomènes similaires lors de la semaine du 19 décembre 2022, en raison de conditions météorologiques défavorables comprenant des grelons, de la neige et de la pluie.
Pendant la semaine du 15 janvier 2024, on observe une chute de température importante, passant de 7°C la semaine précédente à -2,5°C.
Cette semaine-là, on enregistre également des grelons, de la neige et de la pluie, ce qui contribue à une utilisation réduite des vélos.

Ces exemples nous amène à nous demander si une corrélation forte peut être associée entre la météo et l’utilisation des vélos.

### Question 3:  Quelles sont les durées moyennes de trajet ? Quels éléments influent sur cette durée ? (jour de la semaine, type d'utilisateur...)

**Hypothèse :**

En étudiant les durées moyennes de trajet, on s'attend à ce que le jour de la semaine, et le type d'utilisateur influent.
Nous pensons que les durées des trajets sont plus longues le weekend et pour les utilisateurs 'casual'

```{r}

df_duration <- df %>%
  mutate(
    started_at = ymd_hms(started_at),
    ended_at = ymd_hms(ended_at),
    ride_duration = as.numeric(difftime(ended_at, started_at, units = "mins")),
    date = as.Date(started_at)
  )%>%
filter(ride_duration > 0 & ride_duration < 1440)

df_duration %>%
  mutate(day_of_week = wday(started_at, label = TRUE)) %>%
  group_by(day_of_week) %>%
  summarise(mean_duration = mean(ride_duration)) %>%
  
  ggplot(aes(x = day_of_week, y = mean_duration)) +
  geom_col() +
  labs(
    title = "Durée moyenne des trajets par jour de la semaine",
    x = "Jour",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


df_duration %>%
  group_by(member_casual) %>%
  summarise(avg_duration = mean(ride_duration)) %>%
  ggplot(aes(x = member_casual, y = avg_duration, fill = member_casual)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Durée moyenne des trajets selon le type d'utilisateur",
    x = "Type d'utilisateur",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


```

**Interprétation** :

On peut voir dans un premier temps, que la moyenne de trajet la semaine est d'environ 17 minutes tandis que celle durant le weekend est nettement plus élevée avec 25 minutes.
Cela confirme donc nos attentes.
Cela s'explique sûrement par l'utilisation différente des vélos : les gens les utilisent le weekend afin de se promener pour le loisir, tandis que durant la semaine, les utilisateurs s'en servent pour des trajet domicile-travail majoritairement.

Concernant le type d'utilisateur, nos hypothèses étaient justes : les utilisateurs 'casual' se déplacent plus longtemps avec une moyenne de quasiement 30 min tandis que les utilisateurs 'members' utilisent les vélos pendant environ 12 minutes.
Cela s'explique par le fait que les utilisateurs 'casual' font des balades, les utilisent pour visiter par exemple.

### Question 4: Comment les différents types de vélos sont utilisés (type d''utilisateur, évolution...)

**Quelle est l'évolution de l'usage des différents type de vélos ?**

On peut supposer une hausse de l'utilisation de vélos électriques.

```{r}

monthly_usage <- df %>%
  mutate(month = floor_date(as.Date(started_at), unit = "month")) %>%
  group_by(month, rideable_type) %>%
  summarise(nb_trajets = n(), .groups = "drop")

ggplot(monthly_usage, aes(x = month, y = nb_trajets, color = rideable_type)) +
  geom_line(size=1) +
  scale_color_brewer(palette = "Set2")+
  labs(
    title = "Évolution mensuelle du nombre d'utilisations par type de vélo",
    x = "Mois",
    y = "Nombre de trajets",
    color = "Type de vélo"
  ) +
  scale_y_continuous(labels = scales::comma)+
  theme_minimal()
```

**Interprétation**

L'évolution mensuelle du nombre d'utilisations par type de vélos permet de montrer plusieurs tendances intéressantes.
On peut tout d'abord voir que les vélos « docked » c'est-à-dire les vélos qui se prennent et rendent à des stations ont été les plus populaires avant 2021 mais ont connu une grosse diminution au profit de vélos « classiques ».
Ces vélos peuvent être posés et rendus n'importe où et ne nécessitent pas d'être rattachés à une station.
Ensuite entre 2021 et 2024, le vélo classique a été largement le plus utilisé avant d'être dépassé par les vélos « électriques » qui ont connu une hausse significative à partir de 2023.
Ce graphique montre également que l'utilisation des vélos suit un cycle saisonnier, aspect qui sera détaillé dans une autre visualisation.
Ces données suggèrent une modernisation de la flotte de Capital Bike Share, et une transition des utilisateurs vers des vélos plus confortables qui demandent moins d'efforts (électriques) ainsi que des vélos qui leur permettent plus de flexibilité en terme de localisation d'emprunt et de rendu (diminution des « docked »)

On peut également s'interroger sur l'utilisation des différents types de vélos par les 2 types d'utilisateurs, y a t -il une différence ? 

**Hypothèse** 
Nous supposons que les utilisateurs 'casual' préfèrent les vélos électriques, puisque qu'ils les utilisent probablement pour se balader, pour visiter...


**Graphique**
```{r}

df_prop <- df %>%
  group_by(member_casual, rideable_type) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(member_casual) %>%
  mutate(proportion = n / sum(n) * 100)


ggplot(df_prop, aes(x = member_casual, y = proportion, fill = rideable_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Répartition des types de vélos par type d'utilisateur",
    x = "Type d'utilisateur", y = "Proportion (%)", fill = "Type de vélo"
  ) +
  theme_minimal()

df_prop <- df %>%
  group_by(member_casual, rideable_type) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(member_casual) %>%
  mutate(proportion = n / sum(n) * 100)

ggplot(df_prop, aes(x = member_casual, y = proportion, fill = rideable_type)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Répartition des types de vélos par utilisateur",
    x = "Type d'utilisateur",
    y = "Proportion (%)",
    fill = "Type de vélo"
  ) +
  theme_minimal()

```

**Interpétation**
On peut voir que les utilisateurs 'membres' utilisent les vélos classiques et moins les "docked" comparé aux utilisateurs "casuals". 
Cela peut être dû au fait que les docked existaient avant les classic et ne sont plus très présents, mais qu'en parallèle de ça il y a de plus en plus de trajets de members.

**Graphique**

```{r}

df_evolution <- df %>%
  mutate(month = floor_date(date, "month")) %>%  # ou "week" / "day"
  group_by(month, member_casual) %>%
  summarise(nb_trajets = n(), .groups = "drop")

ggplot(df_evolution, aes(x = month, y = nb_trajets, color = member_casual)) +
  geom_line(size = 1.2) +
  scale_color_brewer(palette = "Set2")+
  geom_point() +
  labs(
    title = "Évolution du nombre de trajets par type d'utilisateur",
    x = "Date",
    y = "Nombre de trajets",
    color = "Type d'utilisateur"
  ) +
  theme_minimal()
```

**Interprétation**

On peut voir sur le graphique, qu'il y a de plus en plus de trajets fait par des membres.
Il y a donc probablement plus de trajets de membres avec des vélos classiques qu'avec des vélos docked puisqu'il n'y a quasiement plus de vélos docked tandis qu'il y a énormement de vélos classiques en circulation.
On peut donc en conclure, que les différents types d'utilisateurs ne choississent pas sécifiquement le type de vélos qu'ils utilisent.
Il n'y a pas vraiment de différence d'utilisation.

### Question 5 : Selon les saisons, la fréquence de cyclistes occasionnels change-t-elle comparé aux membres ?

**Hypothèse** :
On peut supposer que les cyclistes occasionnels sont plus sensibles aux conditions météorologiques et aux périodes touristiques. Ainsi, leur fréquence d’utilisation augmenterait significativement pendant les saisons plus favorables comme le printemps et surtout l’été, où le climat est agréable et les activités extérieures sont privilégiées.

À l’inverse, les membres abonnés continueraient à utiliser le service de manière plus stable tout au long de l’année, y compris en automne et en hiver, notamment pour des trajets domicile-travail.

On s’attend donc à observer une variation saisonnière marquée chez les usagers occasionnels, contrairement aux membres réguliers.

**Graphique** :
```{r}
# Fonction de transformation mois -> saison
get_season <- function(month) {
  case_when(
    month %in% c(12, 1, 2)  ~ "Hiver",
    month %in% c(3, 4, 5)   ~ "Printemps",
    month %in% c(6, 7, 8)   ~ "Été",
    month %in% c(9, 10, 11) ~ "Automne"
  )
}

# Préparation des données avec regroupement par saison
seasonal_rides <- df %>%
  transmute(
    user_type = recode(member_casual,
                       "casual" = "Occasionnel",
                       "member" = "Abonné"),
    month = month(started_at),
    season = get_season(month)
  ) %>%
  count(user_type, season) %>%
  mutate(season = factor(season, levels = c("Printemps", "Été", "Automne", "Hiver")))

# Visualisation
ggplot(seasonal_rides, aes(x = season, y = n, group = user_type, color = user_type)) +
  geom_line() +
  scale_color_brewer(palette = "Set2")+
  geom_point() +
  labs(
    title = "Évolution saisonnière du nombre de trajets selon le type d'utilisateur",
    x = "Saison",
    y = "Nombre de trajets",
    color = "Type d'utilisateur"
  ) +
  theme_minimal()
```
**Interprétation** :
Ce graphique représente l’évolution saisonnière du nombre de trajets effectués par les abonnés et les usagers occasionnels.

Similarité dans les tendances :
On remarque que les deux types d’utilisateurs suivent une évolution très similaire au fil des saisons :

* Un pic d’utilisation en été, suivi du printemps,
* Une baisse à l’automne,
* Et un minimum en hiver.

Cela suggère que les comportements saisonniers (influencés par la météo, les vacances, etc.) touchent de manière comparable abonnés et occasionnels.

Différence de volume :
En revanche, le nombre de trajets est systématiquement plus élevé chez les abonnés, quelle que soit la saison :

* En été, ils réalisent environ 3,37 millions de trajets contre 2,5 millions pour les occasionnels.
* En hiver, bien que l’usage chute pour les deux groupes, les abonnés restent nettement plus actifs (1,5 million vs 0,65 million).

Cela indique qu’il existe une base d’usagers réguliers bien plus importante, qui continue d’utiliser le service toute l’année, même en conditions moins favorables.

### Question 6 : En se focalisant sur les utilisateurs, y a-t-il des effets “heures de pointe” dans la journée ?

**Hypothèse** :
Les utilisateurs abonnés adoptent très probablement des comportements liés à leur routine quotidienne (trajets domicile-travail par exemple). Ils seraient donc plus susceptibles d’utiliser les vélos pendant les heures de pointe, notamment en début de matinée (trajet vers le travail) et en fin de journée (retour).

À l’inverse, les utilisateurs occasionnels ont une utilisation plus flexible et dispersée dans la journée, et leur recours aux vélos ne devrait pas particulièrement se concentrer sur les heures de pointe.

On s’attend donc à observer des pics d’utilisation pendant les heures de pointe uniquement chez les abonnés, tandis que les utilisateurs occasionnels auront une répartition horaire plus homogène au cours de la journée.

**Graphique** :
```{r}
# Extraction de l'heure et du type d'utilisateur
rides_user_hours <- df %>%
  transmute(
    user_type = member_casual,            # Type d'utilisateur (membre ou occasionnel)
    hour = hour(started_at)               # Heure de départ
  ) %>%
  count(user_type, hour) %>%              # Nombre de trajets par heure et par type
  group_by(user_type) %>%
  mutate(prop = n / sum(n)) %>%           # Proportions pour comparer les profils
  ungroup()

# Visualisation membres
rides_user_hours %>%
  filter(user_type == "member") %>%
  ggplot(aes(x = hour, y = prop)) +
  geom_col(fill=my_colors[1]) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Répartition horaire des trajets — Utilisateurs abonnés",
    x = "Heure de départ",
    y = "Proportion des trajets"
  ) +
  theme_minimal()

# Visualisation occasionnels
rides_user_hours %>%
  filter(user_type == "casual") %>%
  ggplot(aes(x = hour, y = prop)) +
  geom_col(fill=my_colors[2]) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Répartition horaire des trajets — Utilisateurs occasionnels",
    x = "Heure de départ",
    y = "Proportion des trajets"
  ) +
  theme_minimal()
```

**Interprétation** :
Le graphique montre la répartition horaire des trajets effectués selon le type d’utilisateur (abonné ou occasionnel), en pourcentage du total des trajets de chaque groupe.

On constate que :

Les abonnés présentent des pics très marqués à 8 h (7,1% des trajets) et 17–18 h (10% et 8,9%), ce qui correspond clairement aux heures de pointe traditionnelles. On note aussi une activité significative dès 6 h du matin (2%), ce qui renforce l’idée d’un usage dans le cadre de déplacements domicile-travail.

À l’inverse, les occasionnels ont une distribution plus lissée dans la journée, avec une montée progressive de l'activité à partir de 7 h, avec un pic à 17 h (autour de 9.5%) et un déclin en soirée. Il n’y a pas de véritables heures de pointe, ce qui traduit un usage plus souple et orienté loisir.

Ces résultats confirment que les abonnés sont des usagers réguliers qui utilisent le service dans un cadre professionnel. En revanche, les cyclistes occasionnels exploitent davantage le service en dehors des pics, ce qui reflète une utilisation non contrainte par des horaires fixes.

# Utilisation des stations 

### Question 7 : Quelles stations sont les plus utilisées pour les départs/arrivées ?

Pour cette analyse fondamentale, nous avons voulu identifier les stations centrales du système Capital Bikeshare en examinant leur fréquentation absolue. Cette question constitue un préalable essentiel pour comprendre la hiérarchie spatiale du réseau et formuler des hypothèses sur les facteurs géographiques qui déterminent l'attractivité des stations.

Notre hypothèse initiale supposait une correspondance entre les stations les plus utilisées pour les départs et les arrivées, avec une localisation privilégiée près de secteurs dynamiques (gares, centres commerciaux, quartiers d'affaires). Cette hypothèse reflète l'idée d'un équilibre global du système malgré des flux directionnels ponctuels.

Pour tester cette hypothèse, nous avons :
- Compté le nombre total de départs et d'arrivées par station
- Identifié le top 10 de chaque catégorie
- Comparé les deux classements pour évaluer leur correspondance
- Analysé la localisation géographique des stations dominantes

**Graphique**

```{r Q7_1}

top_depart <- df %>%
  dplyr::filter(!is.na(start_station_name)& start_station_name != "") %>%
  count(start_station_name, sort = TRUE) %>%
  slice_head(n = 10)

ggplot(top_depart, aes(x = reorder(start_station_name, n), y = n)) +
  geom_bar(stat = "identity", fill=my_colors[1]) +
  coord_flip() +
  labs(
    title = "Top 10 des stations de départ",
    x = "Station de départ",
    y = "Nombre de trajets"
  ) +
  theme_minimal()

top_arrivee <- df %>%
  filter(!is.na(end_station_name)& end_station_name != "") %>%
  count(end_station_name, sort = TRUE) %>%
  slice_head(n = 10)

ggplot(top_arrivee, aes(x = reorder(end_station_name, n), y = n)) +
  geom_bar(stat = "identity", fill=my_colors[2]) +
  coord_flip() +
  labs(
    title = "Top 10 des stations d'arrivée",
    x = "Station d'arrivée",
    y = "Nombre de trajets"
  ) +
  theme_minimal()


```

**Interprétation**

Premièrement, nous pouvons observer que les stations sont quasiment les mêmes pour les départs et les arrivées.
Cela signifie qu'il n'y a pas de déséquilibres au niveau des stations les plus utilisées, il y a de nombreuses personnes qui empruntent des vélos à ces endroits mais il y a beaucoup de vélos qui sont redéposés ici aussi.
On peut par contre se poser la question de pourquoi ces stations sont les plus utilisées.
Pour répondre à cette question nous allons tracer ces stations sur une carte pour régarder les quartiers/les points d'intêrets près de ces stations.

**Graphique**

```{r Q7_2}

top_depart_coords <- df %>%
  filter(!is.na(start_station_name), start_station_name != "") %>%
  count(start_station_name, start_lat, start_lng, sort = TRUE) %>%
  slice_head(n = 10)

leaflet(top_depart_coords) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~start_lng,
    lat = ~start_lat,
    label = ~paste0(start_station_name, ": ", n, " trajets"),
    radius = 6,
    fillColor = my_colors[1],
    color = "black",
    fillOpacity = 0.7,
    stroke = TRUE
  ) %>%
  addLegend("bottomright", colors = my_colors[1], labels = "Stations de départ", title = "Top 10")


top_end_coords <- df %>%
  filter(!is.na(start_station_name), end_station_name != "") %>%
  count(end_station_name, end_lat, end_lng, sort = TRUE) %>%
  slice_head(n = 10)

leaflet(top_end_coords) %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~end_lng,
    lat = ~end_lat,
    label = ~paste0(end_station_name, ": ", n, " trajets"),
    radius = 6,
    fillColor = my_colors[2],
    color = "black",
    fillOpacity = 0.7,
    stroke = TRUE
  ) %>%
  addLegend("bottomright", colors = my_colors[2], labels = "Stations d'arrivées", title = "Top 10")

```

**Interprétation** :

Les stations Lincoln Memorial, Jefferson Dr & 14th St SW et 4th St & Madison Dr NW sont localisés près du National Mall, qui est une zone très touristique de Washington.\
Ensuite, la station Columbus Circle/Union Station est devant l'Union Station qui est un grand hub de transport (métro, gare routière, gare...)\
Les autres stations sont dans des quartiers résidentiels ou des zones de bureaux très denses.

Cette identification des stations centrales soulève une question d'usage : ces volumes élevés correspondent-ils à des profils d'utilisation spécifiques ? L'analyse des durées de trajets par station permettra de comprendre si les stations les plus fréquentées sont utilisées pour des trajets courts (transit) ou longs (récréation).

### Question 8 :

**Quelles stations sont les plus actives à différentes périodes de la journée ?**

Pour cette analyse, nous avons examiné comment l'activité des stations varie selon les heures de la journée.
Cette question est essentielle pour comprendre les cycles d'utilisation quotidiens et optimiser la redistribution des vélos aux moments stratégiques.

Notre démarche a consisté à analyser finement la distribution horaire des départs et des arrivées.
Pour cela, nous avons :

-   Extrait l'heure de départ et d'arrivée à partir des variables started_at et ended_at
-   Agrégé les données par heure et par station pour quantifier le nombre de trajets
-   Identifié les 20 stations les plus actives pour améliorer la lisibilité
-   Créé des heatmaps visualisant l'intensité d'utilisation selon l'heure
-   Filtré la période nocturne (0h-5h) pour mieux faire ressortir les tendances principales

```{r Q8, echo=FALSE, warning=FALSE}

# Extract heure
df$heure_start <- hour(ymd_hms(df$started_at))

# Agréger par heure et station de départ
df_heat <- df %>%
  group_by(start_station_name, heure_start) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 20
top_stations <- df_heat %>% 
  group_by(start_station_name) %>% 
  summarise(total = sum(nb_trajets)) %>% 
  top_n(20, total) %>% pull(start_station_name)

df_heat_top <- df_heat %>% filter(start_station_name %in% top_stations)

# Suppression NA (les autres stations apres filtre)
df_heat_top <- df_heat_top %>% filter(!is.na(start_station_name))

# Calculer l'ordre des stations par popularité
station_order <- df_heat_top %>%
  group_by(start_station_name) %>%
  summarise(total_trajets = sum(nb_trajets)) %>%
  arrange(desc(total_trajets)) %>%
  pull(start_station_name)

df_heat_top <- df_heat_top %>%
  mutate(start_station_name = factor(start_station_name, levels = station_order))

df_heat_top_filtre <- df_heat_top %>%
  filter(!(heure_start >= 0 & heure_start <= 5))

# HEATMAP filtre sur 2 a 5h du matin
ggplot(df_heat_top_filtre, aes(x = heure_start, y = reorder(start_station_name, desc(start_station_name)), fill = nb_trajets)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Stations de départ les plus actives \n dans la journée",
       x = "Heure", y = "Station", fill = "Nombre de début de trajets") +
  theme_minimal()


# Extract heure
df$heure_end <- hour(ymd_hms(df$ended_at))

# Agréger par heure et station de arrivée
df_heat <- df %>%
  group_by(end_station_name, heure_end) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 20
top_stations <- df_heat %>% 
  group_by(end_station_name) %>% 
  summarise(total = sum(nb_trajets)) %>% 
  top_n(20, total) %>% pull(end_station_name)

df_heat_top <- df_heat %>% filter(end_station_name %in% top_stations)

# Suppression NA (les autres stations apres filtre)
df_heat_top <- df_heat_top %>% filter(!is.na(end_station_name))

# Calculer l'ordre des stations par popularité
station_order <- df_heat_top %>%
  group_by(end_station_name) %>%
  summarise(total_trajets = sum(nb_trajets)) %>%
  arrange(desc(total_trajets)) %>%
  pull(end_station_name)

df_heat_top <- df_heat_top %>%
  mutate(end_station_name = factor(end_station_name, levels = station_order))

df_heat_top_filtre <- df_heat_top %>%
  filter(!(heure_end >= 0 & heure_end <= 5))

# HEATMAP filtre sur 2 a 5h du matin
ggplot(df_heat_top_filtre, aes(x = heure_end, y = reorder(end_station_name, desc(end_station_name)), fill = nb_trajets)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Stations d'arrivée les plus actives \n dans la journée",
       x = "Heure", y = "Station", fill = "Nombre de fin de trajets") +
  theme_minimal()

```

**Interprétation**

L'analyse des heatmaps représentant l'activité des stations de départ et d'arrivée en fonction de l'heure de la journée révèle des modèles d'utilisation distincts qui dessinent la géographie fonctionnelle de Washington D.C.

Les stations révèlent deux profils d'utilisation bien différenciés. "New Hampshire Ave & T St NW" et "Columbus Circle/Union Station" présentent des pics d'activité marqués pendant les heures de pointe (7-9h pour les départs, 17-19h pour les arrivées), caractéristiques d'un flux pendulaire prononcé. Cette asymétrie temporelle témoigne d'une utilisation principalement liée aux déplacements domicile-travail, où les résidents utilisent ces stations comme points de départ matinaux vers le centre-ville et points d'arrivée lors du retour en soirée.

À l'opposé, "Lincoln Memorial" et "Jefferson Dr & 14th St SW" montrent une activité plus étalée sur la journée avec des pics en milieu de journée (11h-15h). Cette distribution reflète leur fonction récréative et touristique, où l'utilisation suit les rythmes de visite plutôt que les contraintes professionnelles. L'activité soutenue en milieu de journée confirme leur attrait pour les touristes et les activités de loisir.

**Les deux cartes interactives ci-dessous enrichissent cette analyse en révélant la dimension spatiale de ces patterns temporels :**

```{r Q8_map_1}
df_2024 <- df %>%
  filter(year(started_at) == 2024)

# Calculer l'activité des stations (départs)
station_activity <- df_2024 %>%
  mutate(heure = hour(started_at)) %>%
  # Filtrer pour ne garder que les stations avec coordonnées valides
  filter(!is.na(start_lat) & !is.na(start_lng)) %>%
  group_by(start_station_name, start_lat, start_lng) %>%
  summarise(
    nb_trajets = n(),
    # Heure de pointe du matin (6h-9h)
    matin = sum(heure >= 6 & heure <= 10),
    # Heure de pointe du soir (16h-19h)
    soir = sum(heure >= 16 & heure <= 20),
    # Milieu de journée (10h-15h)
    journee = sum(heure >= 11 & heure <= 15),
    .groups = "drop"
  ) %>%
  # Calculer quelle période a le plus de trajets
  # Avec une condition supplémentaire pour "Matin et Soir"
  mutate(
    # Calculer la différence relative entre matin et soir
    diff_matin_soir = abs(matin - soir) / pmax(matin, soir),
    
    peak_period = case_when(
      # Si matin et soir sont proches (moins de 15% de différence) et plus grands que journée
      diff_matin_soir <= 0.15 & matin > journee & soir > journee ~ "Matin et Soir",
      matin > soir & matin > journee ~ "Matin (6h-10h)",
      soir > matin & soir > journee ~ "Soir (16h-20h)",
      journee > matin & journee > soir ~ "Journée (11h-15h)",
      TRUE ~ "Équilibré"
    )
  ) %>%
  # Filtrer pour garder les stations les plus actives (top 50)
  top_n(50, nb_trajets)

# Définir une palette de couleurs pour les périodes de pointe avec la nouvelle catégorie
period_colors <- colorFactor(
  palette = c("blue", "green", "red", "orange", "purple"),
  domain = c("Matin (6h-10h)", "Journée (11h-15h)", "Soir (16h-20h)", "Matin et Soir", "Équilibré")
)

# Créer la carte
map <- leaflet(station_activity) %>%
  addTiles() %>%  # Ajouter la carte de base OpenStreetMap
  addCircleMarkers(
    ~start_lng, ~start_lat,
    color = ~period_colors(peak_period),
    radius = ~sqrt(nb_trajets)/10,  # Taille basée sur le nombre de trajets
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    popup = ~paste(
      "<b>", start_station_name, "</b><br/>",
      "Total trajets: ", nb_trajets, "<br/>",
      "Pic d'activité: ", peak_period, "<br/>",
      "Matin (6h-10h): ", matin, " trajets<br/>",
      "Journée (11h-15h): ", journee, " trajets<br/>",
      "Soir (16h-20h): ", soir, " trajets"
    ),
    # Option pour améliorer l'interaction
    options = markerOptions(riseOnHover = TRUE)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = period_colors,
    values = ~peak_period,
    title = "Pic d'activité",
    opacity = 0.7
  )

# Afficher la carte
map


```


```{r Q8_map_2}
df_2024 <- df %>%
  filter(year(ended_at) == 2024)

# Calculer l'activité des stations (départs)
station_activity <- df_2024 %>%
  mutate(heure = hour(ended_at)) %>%
  # Filtrer pour ne garder que les stations avec coordonnées valides
  filter(!is.na(end_lat) & !is.na(end_lng)) %>%
  group_by(end_station_name, end_lat, end_lng) %>%
  summarise(
    nb_trajets = n(),
    # Heure de pointe du matin (6h-9h)
    matin = sum(heure >= 6 & heure <= 10),
    # Heure de pointe du soir (16h-19h)
    soir = sum(heure >= 16 & heure <= 20),
    # Milieu de journée (10h-15h)
    journee = sum(heure >= 11 & heure <= 15),
    .groups = "drop"
  ) %>%
  # Calculer quelle période a le plus de trajets
  # Avec une condition supplémentaire pour "Matin et Soir"
  mutate(
    # Calculer la différence relative entre matin et soir
    diff_matin_soir = abs(matin - soir) / pmax(matin, soir),
    
    peak_period = case_when(
      # Si matin et soir sont proches (moins de 15% de différence) et plus grands que journée
      diff_matin_soir <= 0.15 & matin > journee & soir > journee ~ "Matin et Soir",
      matin > soir & matin > journee ~ "Matin (6h-10h)",
      soir > matin & soir > journee ~ "Soir (16h-20h)",
      journee > matin & journee > soir ~ "Journée (11h-15h)",
      TRUE ~ "Équilibré"
    )
  ) %>%
  # Filtrer pour garder les stations les plus actives (top 50)
  top_n(50, nb_trajets)

# Définir une palette de couleurs pour les périodes de pointe avec la nouvelle catégorie
period_colors <- colorFactor(
  palette = c("blue", "green", "red", "orange", "purple"),
  domain = c("Matin (6h-10h)", "Journée (11h-15h)", "Soir (16h-20h)", "Matin et Soir", "Équilibré")
)

# Créer la carte
map <- leaflet(station_activity) %>%
  addTiles() %>%  # Ajouter la carte de base OpenStreetMap
  addCircleMarkers(
    ~end_lng, ~end_lat,
    color = ~period_colors(peak_period),
    radius = ~sqrt(nb_trajets)/10,  # Taille basée sur le nombre de trajets
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1,
    popup = ~paste(
      "<b>", end_station_name, "</b><br/>",
      "Total trajets: ", nb_trajets, "<br/>",
      "Pic d'activité: ", peak_period, "<br/>",
      "Matin (6h-10h): ", matin, " trajets<br/>",
      "Journée (11h-15h): ", journee, " trajets<br/>",
      "Soir (16h-20h): ", soir, " trajets"
    ),
    # Option pour améliorer l'interaction
    options = markerOptions(riseOnHover = TRUE)
  ) %>%
  addLegend(
    position = "bottomright",
    pal = period_colors,
    values = ~peak_period,
    title = "Pic d'activité",
    opacity = 0.7
  )

# Afficher la carte
map
```

La carte des départs met en évidence la typologie fonctionnelle des quartiers :

- Stations bleues (pic matin 6h-10h) : localisées dans les zones résidentielles périphériques, elles confirment leur rôle de "gares de départ" pour les trajets pendulaires
- Stations orange (matin et soir) : situées dans des zones mixtes résidentiel/commercial, elles témoignent d'une double fonction dans les flux urbains
- Stations vertes (pic journée) : concentrées autour des sites touristiques et institutionnels

La carte des arrivées révèle les zones d'attraction urbaine :

- Stations rouges (pic soir 16h-20h) : marquent les destinations de retour vers les quartiers résidentiels
- Stations vertes (pic journée) : confirment les pôles touristiques et de loisir comme destinations privilégiées en milieu de journée

Cette double perspective géographique confirme l'hypothèse d'un système organisé autour de flux pendulaires structurés, avec des nuances selon la fonction urbaine des quartiers. La complémentarité spatiale entre les patterns de départ et d'arrivée illustre parfaitement les mouvements directionnels qui caractérisent la mobilité urbaine de Washington D.C.

Après avoir identifié ces variations horaires d'activité et leur distribution géographique, il devient pertinent d'analyser comment ces patterns se différencient entre la semaine et le week-end. Cette analyse temporelle complémentaire nous permettra de distinguer plus finement les stations principalement utilisées pour les trajets domicile-travail de celles fréquentées pour des activités de loisirs, et de valider les hypothèses émises sur les profils fonctionnels des différentes zones de la capitale.

### Question 9 :

**Quelles sont les stations les plus utilisées le week-end, en semaine ?**

Pour cette analyse, nous avons voulu examiner comment l'utilisation des stations varie entre la semaine et le week-end.
Cette question est pertinente car elle permet de distinguer les stations principalement utilisées pour les trajets domicile-travail (en semaine) de celles fréquentées pour des activités de loisirs (week-end).

Notre démarche a consisté à transformer les données temporelles pour catégoriser chaque trajet selon qu'il a lieu en semaine ou le week-end.
Pour cela, nous avons :

-   Extrait le jour de la semaine à partir de la variable started_at
-   Créé une variable binaire "type_jour" (Semaine/Week-end)
-   Agrégé les données par station et par type de jour
-   Filtré les 10 stations les plus actives pour améliorer la lisibilité

```{r Q9, echo=FALSE, warning=FALSE}

# Extract jour
df$date <- ymd_hms(df$started_at)
df$jour_semaine <- wday(df$date, label = TRUE, week_start = 1) # 1 = lundi, 7 = dimanche
df$type_jour <- ifelse(df$jour_semaine %in% c("Sat", "Sun"), "Week-end", "Semaine")

# Agréger par station et type jour
df_bar <- df %>%
  group_by(start_station_name, type_jour) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 10 stations
top_stations2 <- df_bar %>%
  group_by(start_station_name) %>%
  summarise(total = sum(nb_trajets)) %>%
  top_n(10, total) %>%
  pull(start_station_name)

# Filtre du TOP 10
df_bar_top <- df_bar %>% filter(start_station_name %in% top_stations2)

# Suppression NA (les autres stations apres filtre)
df_bar_top <- df_bar_top %>% filter(!is.na(start_station_name))


ggplot(df_bar_top, aes(x = reorder(start_station_name, nb_trajets), y = nb_trajets, fill = type_jour)) +
  geom_bar(stat = "identity",fill =my_colors[1] ) +
  coord_flip() +
  labs(title = "Stations les plus utilisées : week-end vs semaine",
       x = "Station", y = "Nombre de trajets", fill = "Jour") +
  scale_fill_manual(values = c("Week-end" = my_colors[1], "Semaine" = my_colors[2])) +
  theme_minimal()

# STACKED BARPLOT Pourcentage
ggplot(df_bar_top, aes(x = reorder(start_station_name, nb_trajets), y = nb_trajets, fill = type_jour)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(title = "Stations les plus utilisées en % : week-end vs semaine",
       x = "Station", y = "Proportion des trajets (%)", fill = "Jour") +
  scale_fill_manual(values = c("Week-end" = my_colors[1], "Semaine" = my_colors[2])) +
  theme_minimal()
```

**Interprétation**

L'analyse comparative semaine/week-end confirme les profils fonctionnels identifiés dans l'analyse horaire et révèle trois typologies distinctes de stations.

**Stations à vocation pendulaire** : Columbus Circle/Union Station (80% semaine) et New Hampshire Ave & T St NW (75% semaine) confirment leur rôle dans la mobilité professionnelle, avec une chute drastique d'activité le week-end caractéristique des flux domicile-travail.

**Stations touristiques** : Lincoln Memorial et Jefferson Dr & 14th St SW se distinguent par une utilisation week-end exceptionnellement élevée (35-40%), validant leur vocation récréative identifiée lors de l'analyse des pics horaires en milieu de journée.

**Stations mixtes** : Les autres stations présentent des profils intermédiaires (20-25% week-end) reflétant leur positionnement géographique entre zones résidentielles et d'attraction.

Cette segmentation temporelle valide parfaitement la géographie fonctionnelle observée précédemment : les stations à pics matinaux/vespéraux correspondent aux profils pendulaires, tandis que celles à activité étalée en journée maintiennent une utilisation week-end soutenue.

Ces différences d'usage selon les périodes créent-elles des déséquilibres géographiques durables dans le système ? L'analyse des flux directionnels devient cruciale pour comprendre si cette spécialisation fonctionnelle génère des contraintes opérationnelles de redistribution des vélos.

### Question 10 :

**Existe-t-il des stations avec un fort déséquilibre entre départs et arrivées ?**

Pour cette analyse, nous avons cherché à identifier les stations présentant des asymétries importantes entre le nombre de trajets qui y débutent et ceux qui s'y terminent. Cette question prolonge naturellement l'analyse des profils temporels en révélant les conséquences directionnelles des patterns d'usage identifiés précédemment.

Notre approche a consisté à calculer la différence nette entre départs et arrivées pour chaque station. Pour cela, nous avons :

- Calculé le nombre total de départs et d'arrivées par station
- Déterminé la différence nette (départs - arrivées)
- Filtré les stations avec plus de 200 trajets pour assurer la significativité
- Identifié les 15 stations présentant les déséquilibres les plus marqués
- Catégorisé les stations selon leur type de déséquilibre

```{r Q10 ,warning=FALSE}

station_balance <- df_usage %>%
    group_by(station_name) %>%
    summarise(
      total_departures = sum(pickup_counts, na.rm = TRUE),
      total_arrivals = sum(dropoff_counts, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      total_activity = total_departures + total_arrivals,
      net_difference = total_departures - total_arrivals,
      percent_imbalance = round(100 * net_difference / total_activity, 1),
      balance_direction = ifelse(net_difference > 0, "Surplus départs", "Surplus arrivées")
    ) %>%
    filter(total_activity >= 200) %>%
    arrange(desc(abs(net_difference))) %>%
    head(15) %>%
    mutate(
      # Raccourcir les noms sans stringr
      station_name_display = ifelse(
        nchar(station_name) > 35,
        paste0(substr(station_name, 1, 32), "..."),
        station_name
      )
    ) %>%
    arrange(abs(net_difference))  # Pour l'ordre dans le graphique

# 2. CRÉATION DU BARPLOT PRINCIPAL ----
create_balance_barplot <- function(balance_data) {
  
  # Palette de couleurs
  colors <- c("Surplus départs" = my_colors[1], "Surplus arrivées" = my_colors[2])
  
  ggplot(balance_data, aes(x = reorder(station_name_display, abs(net_difference)), 
                          y = net_difference, 
                          fill = balance_direction)) +
    
    # Barres principales
    geom_col(alpha = 0.8, width = 0.7) +
    
    # Ligne de référence à zéro
    geom_hline(yintercept = 0, color = "black", size = 0.5, linetype = "solid") +
    
    # Annotations des valeurs sur les barres
    geom_text(
      aes(label = paste0(ifelse(net_difference > 0, "+", ""), 
                        format(net_difference, big.mark = " "))),
      hjust = ifelse(balance_data$net_difference > 0, -0.1, 1.1),
      size = 3,
      color = "black",
      fontface = "bold"
    ) +
    
    # Retourner le graphique (barres horizontales)
    coord_flip() +
    
    # Échelles et couleurs
    scale_fill_manual(values = colors, name = "Type de déséquilibre") +
    scale_y_continuous(
      labels = function(x) format(x, big.mark = " "),
      expand = expansion(mult = c(0.15, 0.15))
    ) +
    
    # Thème et mise en forme
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40", margin = margin(b = 20)),
      plot.caption = element_text(size = 9, color = "gray50", hjust = 1),
      
      axis.title.x = element_text(size = 11, face = "bold"),
      axis.title.y = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 9),
      
      legend.position = "bottom",
      legend.title = element_text(size = 10, face = "bold"),
      legend.text = element_text(size = 9),
      
      panel.grid.major.y = element_line(color = "gray90", size = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_line(color = "gray95", size = 0.3),
      
      plot.margin = margin(15, 15, 15, 15)
    ) +
    
    # Labels
    labs(
      title = "Stations avec le plus fort déséquilibre départs/arrivées",
      subtitle = "Différence nette entre le nombre de départs et d'arrivées par station",
      x = "Station",
      y = "Différence nette (Départs - Arrivées)",
      caption = paste("Stations avec >200 trajets • Top", nrow(balance_data))
    )
}


# Graphique principal
main_plot <- create_balance_barplot(station_balance)
print(main_plot)
```

**Interprétation**

L'analyse des déséquilibres départs/arrivées révèle une géographie fonctionnelle polarisée qui confirme et amplifie les observations des analyses temporelles précédentes.

**Stations "sources" résidentielles** : Les stations à surplus de départs dessinent clairement la carte des quartiers résidentiels. 11th & Kenyon St NW (+21 667) et Park Rd & Holmead Pl NW (+21 573) dominent largement, confirmant leur rôle de "gares de départ" matinales identifié dans l'analyse horaire. Ces déséquilibres massifs témoignent des flux pendulaires sortants vers le centre-ville et créent un besoin constant de réapprovisionnement en vélos.

**Stations "puits" touristiques** : À l'opposé, Georgetown Harbor / 30th St NW (-16 061) et C & O Canal & Wisconsin Ave NW (-13 901) capturent massivement les arrivées sans générer proportionnellement de départs. Ces stations, situées dans la zone touristique de Georgetown, confirment leur statut de destinations privilégiées identifié par leur forte activité week-end dans l'analyse précédente.

Validation des profils fonctionnels : Cette cartographie des déséquilibres valide parfaitement les typologies établies :

- Les stations à profil pendulaire (forte aktivité en semaine, pics matin/soir) génèrent des surplus de départs
- Les stations touristiques (activité week-end élevée, pics journée) accumulent les arrivées
- L'amplitude des déséquilibres (>20 000 trajets) révèle l'intensité des flux directionnels urbains
Implications opérationnelles : Ces asymétries créent des défis logistiques majeurs, nécessitant une redistribution quotidienne des vélos des zones de destination vers les zones de départ pour maintenir l'équilibre du système.

Ces déséquilibres géographiques soulèvent une question complémentaire : quels sont les trajets spécifiques qui alimentent ces flux directionnels ? L'identification des liaisons les plus fréquentes permettra de cartographier précisément les "autoroutes cyclables" de Washington D.C. et de comprendre les mécanismes concrets de ces asymétries spatiales.

### Question 11 :

**Quels sont les trajets les plus fréquents (station de départ vers station d’arrivée)**

Pour cette analyse, nous avons voulu identifier les liaisons spécifiques qui alimentent les flux observés précédemment et comprendre la nature des trajets les plus populaires. Cette question complète parfaitement l'analyse des déséquilibres en révélant les "autoroutes cyclables" concrètes de Washington D.C.

Notre approche a consisté à analyser tous les trajets point-à-point pour identifier les patterns de circulation. Pour cela, nous avons :

- Calculé la fréquence de chaque paire origine-destination
- Distingué les trajets "en boucle" (même station de départ et d'arrivée) des trajets "directionels"
- Analysé la distribution des durées pour comprendre les usages
- Identifié les top 10 de chaque catégorie

```{r Q11_1,warning=FALSE}
# 1. Calculer les trajets les plus fréquents
top_routes <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "") %>%
  
  # Créer un label pour l'axe des abscisses (trajet)
  mutate(
    trajet = paste(start_station_name, "→", end_station_name),
    # Raccourcir les noms si ils sont trop longs pour l'affichage
    trajet_court = ifelse(nchar(trajet) > 50, 
                         paste0(substr(trajet, 1, 47), "..."), 
                         trajet)
  )%>%
  
  # Grouper par paire de stations et compter les trajets
  group_by(trajet,trajet_court) %>%
  summarise(
    nombre_trajets = n(),
    .groups = 'drop'
  ) %>%
  
  # Trier par nombre de trajets décroissant
  arrange(desc(nombre_trajets)) %>%
  
  # Garder le top 10
  head(10) 

# 2. Créer le barplot
plot_top_routes <- ggplot(top_routes, aes(x = reorder(trajet_court, nombre_trajets), 
                                         y = nombre_trajets)) +
  geom_col(fill = my_color[1], alpha = 0.8) +
  
  # Centrer les nombres dans les barres
  geom_text(aes(label = scales::comma(nombre_trajets), 
                y = nombre_trajets/2),  # Position au centre de la barre
            hjust = 0.5,  # Centrer horizontalement
            vjust = 0.5,  # Centrer verticalement
            size = 3.5, 
            color = "white",  # Texte blanc pour contraster avec le bleu
            fontface = "bold") +  # Texte en gras pour plus de lisibilité
  
  # Pivoter pour avoir des labels lisibles
  coord_flip() +
  
  # Personnaliser les labels et le titre
  labs(
    title = "Top 10 des trajets les plus fréquents",
    subtitle = "Paires de stations départ → arrivée",
    x = "Trajet (Station de départ → Station d'arrivée)",
    y = "Nombre de trajets",
    caption = paste("Basé sur", scales::comma(nrow(df)), "trajets au total")
  ) +
  
  # Thème propre
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    panel.grid.minor = element_blank()
  )


# 3. Afficher le graphique
print(plot_top_routes)

```

**Interprétation**

Le classement des trajets les plus fréquents révèle un phénomène remarquable : les 10 trajets les plus populaires sont tous des trajets en boucle (même station de départ et d'arrivée), confirmant l'importance de l'usage récréatif et touristique du système Capital Bikeshare.
Cette prédominance s'explique par la concentration de ces stations autour des sites emblématiques de Washington D.C., où les utilisateurs privilégient l'exploration locale plutôt que les déplacements utilitaires.

Jefferson Dr & 14th St SW domine largement avec 19 785 trajets, représentant 0,12% du trafic total, suivi de très près par Smithsonian-National Mall avec 18 657 trajets.
Ces deux destinations phares du National Mall captent à elles seules près de 38 500 trajets en boucle, démontrant leur statut exceptionnel dans l'écosystème touristique de la capitale.
Le groupe suivant se structure autour de trois destinations majeures (4th St & Madison Dr NW, Gravelly Point, Lincoln Memorial) oscillant entre 12 725 et 14 807 trajets, révélant une hiérarchie claire dans l'attractivité des sites patrimoniaux et récréatifs.

Le bas du classement (stations 6 à 10) maintient des volumes substantiels entre 9 785 et 11 777 trajets, confirmant que même les destinations "moins populaires" du top 10 génèrent un trafic récréatif considérable.
Cette répartition démontre que Capital Bikeshare a réussi à créer un réseau de loisirs urbains performant, où chaque station fonctionne comme un hub autonome d'exploration locale.
La structure tarifaire favorisant les trajets de moins de 45 minutes encourage ces usages en boucle, transformant le système en une véritable plateforme de découverte touristique tout en maintenant un modèle économique viable.

Cette prédominance des trajets en boucle masque cependant une réalité importante des déplacements effectifs.
Si nous excluons ces trajets circulaires pour nous concentrer uniquement sur les véritables déplacements d'un point A vers un point B, un paysage très différent émerge

**Top 10 des trajets point-à-point (trajets différents)**

```{r Q11_2,warning=FALSE}
# 1. Calculer les trajets les plus fréquents
top_routes <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" & end_station_name != start_station_name) %>%
  
  # Grouper par paire de stations et compter les trajets
  group_by(start_station_name, end_station_name) %>%
  summarise(
    nombre_trajets = n(),
    .groups = 'drop'
  ) %>%
  
  # Trier par nombre de trajets décroissant
  arrange(desc(nombre_trajets)) %>%
  
  # Garder le top 10
  head(10) %>%
  
  # Créer un label pour l'axe des abscisses (trajet)
  mutate(
    trajet = paste(start_station_name, "→", end_station_name),
    # Raccourcir les noms si ils sont trop longs pour l'affichage
    trajet_court = ifelse(nchar(trajet) > 50, 
                         paste0(substr(trajet, 1, 47), "..."), 
                         trajet)
  )

# 2. Créer le barplot
plot_top_routes <- ggplot(top_routes, aes(x = reorder(trajet_court, nombre_trajets), 
                                         y = nombre_trajets)) +
  geom_col(fill = my_colors[1], alpha = 0.8) +
  
  # Centrer les nombres dans les barres
  geom_text(aes(label = scales::comma(nombre_trajets), 
                y = nombre_trajets/2),  # Position au centre de la barre
            hjust = 0.5,  # Centrer horizontalement
            vjust = 0.5,  # Centrer verticalement
            size = 3.5, 
            color = "black",  
            fontface = "bold") +  # Texte en gras pour plus de lisibilité
  
  # Pivoter pour avoir des labels lisibles
  coord_flip() +
  
  # Personnaliser les labels et le titre
  labs(
    title = "Top 10 des trajets les plus fréquents",
    subtitle = "Paires de stations départ → arrivée",
    x = "Trajet (Station de départ → Station d'arrivée)",
    y = "Nombre de trajets",
    caption = paste("Basé sur", scales::comma(nrow(df)), "trajets au total")
  ) +
  
  # Thème propre
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    panel.grid.minor = element_blank()
  )

# 3. Afficher le graphique
print(plot_top_routes)
```

**Interprétation**

Le classement des trajets point-à-point révèle un paysage beaucoup plus diversifié que les trajets en boucle, mettant en évidence deux logiques d'usage distinctes : les déplacements utilitaires urbains et les circuits touristiques inter-monuments.
Cette analyse dévoile les véritables flux de mobilité du système Capital Bikeshare lorsque les utilisateurs se déplacent effectivement d'un point A vers un point B.

Columbus Circle / Union Station emerge comme un hub de transit majeur, dominant 4 des 10 trajets les plus fréquents avec des connexions bidirectionnelles vers 8th & F St NE (9 603 et 8 206 trajets) et 6th & H St NE (8 697 et 6 578 trajets).
Cette prédominance s'explique par le statut de Union Station comme principale gare ferroviaire de Washington, créant un effet d'attraction naturel pour les correspondances multimodales vers les quartiers résidentiels et professionnels du nord-est.
Les volumes légèrement asymétriques entre les sens aller-retour suggèrent des patterns de mobilité pendulaire avec des pointes directionnelles selon les heures.

Le triangle touristique Lincoln Memorial - Jefferson Memorial - Jefferson Dr & 14th St SW constitue le second cluster dominant avec 6 trajets représentant plus de 38 000 déplacements cumulés.
Le trajet Lincoln Memorial → Jefferson Memorial (8 941 trajets) domine cette catégorie, révélant un circuit patrimonial privilégié par les visiteurs souhaitant relier les deux mémoriaux iconiques en 15-20 minutes de vélo.
La réciprocité quasi-parfaite des flux (8 196 et 8 177 trajets entre Lincoln Memorial et Jefferson Dr & 14th St SW) confirme l'existence de parcours touristiques structurés où le vélo devient l'outil optimal pour découvrir l'ensemble monumental de la capitale américaine.

Maintenant que nous avons identifié la nature particulière des trajets en boucle, analysons plus précisément leurs caractéristiques temporelles pour comprendre les comportements d'usage qui les motivent

**Distribution des temps de trajet" (en pourcentages)** \n Distribution du temps de trajet pour les trajets ayant le meme point de depart et d'arriver \ <https://capitalbikeshare.com/pricing>

```{r Q11_3,warning=FALSE}

# 1. Préparer les données des trajets aller-retour
same_station_duration_data <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" &
         !is.na(started_at) & !is.na(ended_at)) %>%
  
  # Calculer la durée du trajet en minutes
  mutate(
    duration_minutes = as.numeric(difftime(ended_at, started_at, units = "mins")),
    is_same_station = (start_station_name == end_station_name)
  ) %>%
  
  # Garder seulement les trajets aller-retour
  filter(is_same_station == TRUE) %>%
  
  # Filtrer les durées aberrantes (entre 1 minute et 8 heures)
  filter(duration_minutes >= 1 & duration_minutes <= 480)

# 2. Créer les données pour le graphique en ligne (intervalles de 5 minutes)
line_data <- same_station_duration_data %>%
  mutate(
    # Grouper par intervalles de 5 minutes
    duration_interval = floor(duration_minutes / 5) * 5
  ) %>%
  count(duration_interval) %>%
  mutate(
    duration_label = paste0(duration_interval, "-", duration_interval + 5, " min"),
    percentage = round(100 * n / sum(n), 2),
    cumulative_count = cumsum(n),
    cumulative_percentage = round(100 * cumulative_count / sum(n), 1)
  ) %>%
  # Garder seulement les intervalles avec au moins quelques trajets pour la lisibilité
  filter(duration_interval <= 150) %>%  # Jusqu'à 150 minutes pour la lisibilité
  # Garder seulement les intervalles avec au moins quelques trajets pour la lisibilité
  filter(10<=duration_interval)  # Jusqu'à 150 minutes pour la lisibilité

# 4. Graphique en ligne - Pourcentages
plot_line_percentage <- ggplot(line_data, aes(x = duration_interval, y = percentage)) +
  
  geom_line(color = "darkgreen", size = 1.2) +
  geom_point(color = "darkgreen", size = 2) +
  
  # Zones colorées selon les catégories
  geom_area(data = filter(line_data, duration_interval <= 45), 
            aes(x = duration_interval, y = percentage), 
            fill = "#2E7D32", alpha = 0.3) +
  geom_area(data = filter(line_data, duration_interval > 45 & duration_interval <= 75), 
            aes(x = duration_interval, y = percentage), 
            fill = "#FF9800", alpha = 0.3) +
  geom_area(data = filter(line_data, duration_interval > 75), 
            aes(x = duration_interval, y = percentage), 
            fill = "#D32F2F", alpha = 0.3) +
  
  # Remettre la ligne par-dessus
  geom_line(color = "darkgreen", size = 1.2) +
  geom_point(color = "darkgreen", size = 2) +
  
  # Lignes verticales
  geom_vline(xintercept = 45, color = "orange", linetype = "dashed", size = 1) +
  geom_vline(xintercept = 75, color = "red", linetype = "dashed", size = 1) +
  
  labs(
    title = "Distribution des temps de trajet (en pourcentages)",
    subtitle = "Zones colorées : Vert (≤45min), Orange (45-75min), Rouge (>75min)",
    x = "Durée (minutes)",
    y = "Pourcentage des trajets (%)",
    caption = "Intervalles de 5 minutes"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold")
  )

print(plot_line_percentage)

```

**Interprétation**

La distribution des temps de trajet pour les trajets en boucle (même station de départ et d'arrivée) révèle des comportements d'usage particuliers fortement influencés par la structure tarifaire de Capital Bikeshare.
On observe une concentration majeure des trajets dans la zone verte (≤45 minutes), correspondant à la période gratuite pour les abonnés journaliers et annuels, ce qui suggère que de nombreux utilisateurs planifient délibérément leurs sorties récréatives, sportives ou touristiques pour rester dans cette fenêtre sans frais supplémentaires.

La diminution progressive dans la zone orange (45-75 minutes) s'explique par l'introduction des frais de 0,05\$/minute pour les vélos classiques, incitant les utilisateurs à raccourcir leurs balades ou à accepter un coût modéré pour des activités de loisir plus longues.
Cette baisse devient encore plus marquée dans la zone rouge (\>75 minutes), où les coûts cumulés deviennent dissuasifs pour la plupart des utilisateurs occasionnels.

Ces trajets en boucle reflètent principalement des usages de loisir, d'exercice physique ou de découverte touristique plutôt que des déplacements utilitaires.
L'émergence des vélos électriques depuis 2023, malgré leur coût supérieur (0,10-0,15\$/minute), peut expliquer une partie des trajets plus longs car ils permettent d'explorer des distances plus importantes avec moins d'effort, rendant les balades étendues plus accessibles à un public plus large, y compris aux utilisateurs moins sportifs.

Cette distribution globale des temps cache des variations importantes selon les stations.
En détaillant la répartition des durées pour chaque station pratiquant des trajets en boucle, nous pouvons identifier des profils d'usage spécifiques

**Répartition détaillée des durées par station**

```{r Q11_4,warning=FALSE}

library(dplyr)
library(ggplot2)
library(lubridate)

# 1. Calculer les statistiques avec 3 catégories de durée
same_station_rides <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" &
         !is.na(started_at) & !is.na(ended_at)) %>%
  
  # Calculer la durée du trajet en minutes
  mutate(
    duration_minutes = as.numeric(difftime(ended_at, started_at, units = "mins")),
    is_same_station = (start_station_name == end_station_name)
  ) %>%
  
  # Filtrer les durées aberrantes (moins de 1 min ou plus de 8h)
  filter(duration_minutes > 1 & duration_minutes < 480) %>%
  
  # Garder seulement les trajets aller-retour
  filter(is_same_station == TRUE) %>%
  
  # Grouper par station et calculer les statistiques avec 3 catégories
  group_by(start_station_name) %>%
  summarise(
    nombre_trajets_meme_station = n(),
    trajets_45min_moins = sum(duration_minutes <= 45),
    trajets_45min_75min = sum(duration_minutes > 45 & duration_minutes <= 75),
    trajets_75min_plus = sum(duration_minutes > 75),
    
    proportion_45min_moins = round(100 * trajets_45min_moins / n(), 1),
    proportion_45min_75min = round(100 * trajets_45min_75min / n(), 1),
    proportion_75min_plus = round(100 * trajets_75min_plus / n(), 1),
    
    duree_moyenne_minutes = round(mean(duration_minutes, na.rm = TRUE), 1),
    .groups = 'drop'
  ) %>%
  
  # Filtrer les stations avec au moins 10 trajets
  filter(nombre_trajets_meme_station >= 10) %>%
  
  # Trier et garder le top 15
  arrange(desc(nombre_trajets_meme_station)) %>%
  head(15) %>%
  
  # Raccourcir les noms de stations si nécessaire
  mutate(
    station_short = ifelse(nchar(start_station_name) > 30, 
                          paste0(substr(start_station_name, 1, 27), "..."), 
                          start_station_name),
    
    # Créer une catégorie dominante pour la couleur
    dominant_category = case_when(
      proportion_45min_moins >= 50 ~ "Majorité ≤45min",
      proportion_45min_75min >= 40 ~ "Beaucoup 45-75min", 
      proportion_75min_plus >= 30 ~ "Beaucoup >75min",
      TRUE ~ "Mixte"
    ),
    
    # Factoriser pour contrôler l'ordre
    dominant_category = factor(dominant_category, 
                             levels = c("Majorité ≤45min", "Beaucoup 45-75min", 
                                       "Beaucoup >75min", "Mixte"))
  )

# 3. Graphique en barres empilées pour montrer la répartition exacte
library(tidyr)

# Préparer les données pour le graphique empilé
stacked_data <- same_station_rides %>%
  select(station_short, nombre_trajets_meme_station, 
         trajets_45min_moins, trajets_45min_75min, trajets_75min_plus) %>%
  pivot_longer(cols = c(trajets_45min_moins, trajets_45min_75min, trajets_75min_plus),
               names_to = "categorie_duree", 
               values_to = "nombre_trajets") %>%
  mutate(
    categorie_label = case_when(
      categorie_duree == "trajets_45min_moins" ~ "≤45 min",
      categorie_duree == "trajets_45min_75min" ~ "45-75 min", 
      categorie_duree == "trajets_75min_plus" ~ ">75 min"
    ),
    categorie_label = factor(categorie_label, levels = c("≤45 min", "45-75 min", ">75 min"))
  )

plot_stacked <- ggplot(stacked_data, 
                      aes(x = reorder(station_short, nombre_trajets_meme_station), 
                          y = nombre_trajets, 
                          fill = categorie_label)) +
  
  geom_col(position = "stack", alpha = 0.8) +
  
  coord_flip() +
  
  scale_fill_manual(
    values = c("≤45 min" = "#2E7D32",      # Vert
               "45-75 min" = "#FF9800",    # Orange  
               ">75 min" = "#D32F2F")      # Rouge
  ) +
  
  labs(
    title = "Répartition détaillée des durées par station",
    subtitle = "Barres empilées montrant la distribution exacte",
    x = "Station",
    y = "Nombre de trajets",
    fill = "Durée du trajet"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )

print(plot_stacked)

```

**Interprétation**

La répartition des durées de trajets en boucle par station révèle des profils d'usage distincts liés à la vocation géographique et touristique de chaque localisation.
Les stations les plus populaires pour les trajets circulaires se concentrent autour de sites emblématiques de Washington D.C., avec Jefferson Dr & 14th St SW et Smithsonian-National Mall en tête, confirmant l'usage majoritairement récréatif et touristique de ce type de trajet.

On observe une prédominance systématique des trajets courts (≤45 minutes, zone verte) dans toutes les stations, reflétant l'influence de la structure tarifaire gratuite pour les abonnés dans cette tranche.
Cependant, certaines stations comme Jefferson Dr & 14th St SW, Smithsonian-National Mall, et Gravelly Point présentent des proportions plus importantes de trajets moyens et longs (zones orange et rouge), suggérant que ces emplacements favorisent des activités de loisir plus étendues malgré les coûts supplémentaires.

Les stations situées près de sites naturels ou panoramiques (Gravelly Point, Roosevelt Island, National Harbor Carousel) montrent des durées plus variées, indiquant que les utilisateurs sont disposés à payer des frais additionnels pour profiter pleinement de ses environnements particuliers.
À l'inverse, les stations plus urbaines et centrales (15th St & Pennsylvania Ave NW, Jefferson Memorial) présentent une concentration plus marquée dans la zone gratuite, suggérant un usage plus utilitaire ou des contraintes budgétaires plus strictes pour ces localisations.

# Lien avec la météo 


### Question 12 : Est ce que les durées de trajets sont influencés par la météo ? 

**Hypothèse :**
Nous supposons que la durée moyenne de trajet devrait être plus courte les jours de mauvais temps.


```{r}

daily_avg <- df_duration %>%
  filter(ride_duration > 0 & ride_duration < 1440)%>%
  group_by(date) %>%
  summarise(mean_duration = mean(ride_duration, na.rm = TRUE))


weather <- weather %>%
  mutate(datetime = as.Date(datetime))

merged <- daily_avg %>%
  left_join(weather, by = c("date" = "datetime"))


merged %>%
  ggplot(aes(x = temp, y = mean_duration)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, color = "red") +
  labs(
    title = "Durée moyenne des trajets selon la température",
    x = "Température moyenne (°C)",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


merged %>%
  ggplot(aes(x = cloudcover, y = mean_duration)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", color = "blue", se = FALSE) +
  labs(
    title = "Durée moyenne selon la couverture nuageuse",
    x = "Couverture nuageuse (%)",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


merged %>%
  ggplot(aes(x = precip, y = mean_duration)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", color = "blue", se = FALSE) +
  labs(
    title = "Durée moyenne selon les précipitations",
    x = "Précipitations (mm)",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


merged %>%
  ggplot(aes(x = windspeed, y = mean_duration)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", color = "blue", se = FALSE) +
  labs(
    title = "Durée moyenne selon la vitesse du vent",
    x = "Vitesse du vent",
    y = "Durée moyenne (min)"
  ) +
  theme_minimal()


```

**Interprétation** :

On peut voir que les durées moyennes maximum sont atteintes vers 20-25 degrés de température, vers 20km/h de vent et quand il ne pleut pas. Cela signifie que les utilisateurs évitent de faire des grands trajets quand les conditions ne sont pas optimales.

### Question 13 : Comment la météo influence-t-elle l'usage des vélos ?  

**Hypothèse**

On s'intéresse maitenant à d'autres facteurs météorologiques comme le vent, les nuages et la neige sur les durées moyennes des trajets afin de voir si un temps mauvais défavorise l'utilisation du vélo avec les utilisateurs. On remarque qu'il y a 8617 observations où les durées sont négatives car les vélos ont été arrêtés avant d'être pris donc on les enlève de notre visualisation pour ne pas fausser nos calculs de durées de trajets.

**Graphique**
```{r Q14, echo=FALSE}
df$date <- as.Date(df$started_at)
# Calcul de la durée moyenne des trajets par jour
df_duree <- df %>%
  group_by(date) %>%
  filter(ended_at >= started_at) %>%
  summarise(
    duree_moyenne_minute = mean(difftime(ended_at, started_at, units = "mins"), na.rm = TRUE),
    duree_moyenne_hours = mean(difftime(ended_at, started_at, units = "hours"), na.rm = TRUE),
    .groups = "drop")%>%
  #supprimer n outlier en plus de 6h de location qui fausse l'échelle
  filter(duree_moyenne_hours < 6)

# Jointure avec les données météo
df_meteo_duree <- inner_join(df_duree, weather, by = c("date" = "datetime"))

df_meteo_duree$duree_moyenne_minute <- as.numeric(df_meteo_duree$duree_moyenne_minute)
df_meteo_duree$duree_moyenne_hours <- as.numeric(df_meteo_duree$duree_moyenne_hours)


# Graphique : Vent et durée moyenne des trajets
ggplot(df_meteo_duree, aes(x = windspeed, y = duree_moyenne_minute)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(title = "Vent et durée moyenne des trajets",
       x = "Vitesse du vent (km/h)", y = "Durée moyenne des trajets") +
  theme_minimal()

# Graphique : Couverture nuageuse et durée moyenne des trajets
ggplot(df_meteo_duree, aes(x = cloudcover, y = duree_moyenne_minute)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  labs(title = "Couverture nuageuse et durée moyenne des trajets",
       x = "Couverture nuageuse (%)", y = "Durée moyenne des trajets") +
  theme_minimal()

# Graphique : Neige et durée moyenne des trajets
ggplot(df_meteo_duree, aes(x = snow, y = duree_moyenne_minute)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE, aes(color = "Tendance"), span = 1, color = "blue") +
  labs(title = "Neige et durée moyenne des trajets",
       x = "Neige", y = "Durée moyenne des trajets (minutes)") +
  theme_minimal()
```

**Interprétation**
La première visualisation met en relation la vitesse du vent et la durée moyenne des trajets afin d'observer si le vent a un impact sur l'utilisation des vélos des usagers. On observe que la majorité des trajets ont une durée moyenne comprise entre 0 et 60 minutes, quelle que soit la vitesse du vent. Il y a également quelques points extrêmes (outliers) où la durée des trajets est très longue, mais ces cas restent rares. Entre 0 et 20km/h on observe une légère augmentation de l'utilisation sûrement dûe au fait qu'il soit rare que le vent soit en dessous de 20 km/h. Après 20km/h on voit une très légère baisse qui décroit encore plus vers 35 km/h montrant que la durée d'utilisation des vélos est plus faibles. On peut donc dire que les utilisateurs ont tendnace à faire des trajets plus courts lorsque le vent est fort.

La deuxième visualisation met en relation la couverture nuageuse et la durée moyenne des trajets afin d'observer si les nuages ont un impact sur l'utilisation des vélos des usagers. Encore une fois la très grande majorité des points se situe sous les 60 minutes de durée moyenne, quel que soit le pourcentage de couverture nuageuse. La courbe de tendance bleue indique une légère hausse de la durée moyenne des trajets jusqu’à environ 25–30 % de couverture nuageuse, puis une faible diminution à mesure que la couverture nuageuse augmente. Aucun effet marqué ou extrême n’est observé concernant la couverture nuageuse : la dispersion des points reste assez constante sur toute la plage des valeurs. Quelques valeurs extrêmes (outliers) existent aussi pour des durées de trajet très longues, mais elles restent minoritaires.

La troisième visualisation met en relation la neige et la durée moyenne des trajets afin d'observer si la neige a un impact sur l'utilisation des vélos des usagers. La grande majorité des observations se trouvent à 0 de neige, où la durée moyenne des trajets est très variable, avec plusieurs points extrêmes où la durée dépasse 100 minutes. Ceci peut s'expliquer parce que il y a pas beaucoup de moments où il y a de la neuge, ainsi la plupart de smesures ont été faites lorsque neige est à 0.
En présence de neige : Dès qu'il y a présence de neige (valeurs supérieures à 0), le nombre d'observations diminue fortement et la durée moyenne des trajets semble globalement plus faible ou relativement stable, entre 20 et 40 minutes pour la plupart des points.

### Suite question 13 

**Hypothèse** :
Comme on l'a vu précédemment en question 1, les vélos sont moins utilisés en hiver, sûrement parce qu'il fait plus froid. On souhaite maintenant voir de manière plus précise la relation entre la météo (température, pluie) sur l'influence de l'usage des vélos partagés. Ces 2 visulisations permettront d'avoir une perspective approfondie des manières dont les conditons météorologiques impactent l'utilisation.

**Graphique** :

```{r Q12, echo=FALSE}
# Extraction des variables de date et heure
df$date <- as.Date(df$started_at)

# Agrégation des données quotidiennes
df_quotidien <- df %>%
  group_by(date) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# Jointure avec les données météo (supposons que 'meteo' est un dataframe contenant les données météo)
df_meteo <- inner_join(df_quotidien, weather, by = c("date" = "datetime"))

# Visualisation 1 : Température maximale et nombre de trajets par jour
ggplot(df_meteo, aes(x = temp, y = nb_trajets)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relation entre le nombre de trajets par jour et la température maximale",
       x = "Température maximale (°C)", y = "Nombre de trajets par jour") +
  theme_minimal()

# Visualisation 2 : Précipitations et nombre de trajets par jour
ggplot(df_meteo, aes(x = precipcover, y = nb_trajets)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Relation entre le nombre de trajets par jour et les précipitations",
       x = "Précipitations (mm)", y = "Nombre de trajets par jour") +
  theme_minimal()

```

**Interprétation** :
La première visualisation est un nuage de point représentant le nombre de trajets par jour en fonction de la température maximale (en degré celsius) enregistrée dans la journée. La droite de régression en rouge permet d'illustrer la tendance générale. On observe une nette corrélation positive entre l'utilisation des vélos et la température. Cela signifie que lorsque la température augmente, l'utilisation des vélos augmente. Cependant, les points restent assez dispersés montrant que d'autres facteurs influencent sûrement également l'utilisation des vélos partagés.

La deuxième visualisation est elle aussi un nuage de points représentant le nombre de trajets par jour en fonction de la précipitation (en mm). On a aussi ajouté une courbe de régression en bleu montrant la tendance générale. A la différence de la première visualisation, la corrélation entre l'utilisation des vélos et les précipitations est négative. Le résultat est plutôt cohérent, personne n'aime faire du vélo sous la pluie. Comme pour la première visualisation, les points sont dispersés autour de la droite de régression montrant potentiellement l'importance d'autre facteur dans l'utilisation des vélos.

### Question 14

**En cas de température extrême, est-ce que le volume de trajets diminue fortement ?**

**Hypothèse** :

On cherche maintenant à s'intéresser à des cas extrêmes de température pour essayer d'observer un potentiel changement dû à ceci. Ainsi, nous avons cherché 4 évènements inclus dans les dates de nos données où les températures ont été particulièrement basses et hautes pendant une longue durée.

En premier temps nous verrons l'impact de 2 évènements à température froide extrême, et ensuite 2 évènements à température chaude extrême.

Pour les évènements froid, nous en avons choisi un en février 2021, et l'autre en décembre 2022:
En février 2021, Dû à un anticyclone arctique qui a soudainement déplacé de l’air glacial vers le sud. Une vague de froid a débuté au Canada et s'est propagé rapidement sur le territoire américain, affectant particulièrement le Texas, un État généralement habitué à des températures plus chaudes.
Cependant nous avons aussi pu observer une durée de 6 jours à Washington DC où les températures étaient nettement plus basse que les journées précédentes.
Source : https://journals.ametsoc.org/view/journals/bams/103/12/BAMS-D-21-0266.1.xml

En décembre 2022, autour de Noël, un vent froid a balayé la région Washington DC  entraînant des températures extrêmes en dessous de 0 en raison de fréquentes rafales de vent à environ 48km/h.
Source : https://www.weather.gov/mrx/December_2022_Record_Cold

Comme on l'a observé dans la question précédente, la température a un effet sur l'utilisation des usagers, ainsi nous pensons que l'utilisation sera réduites lors de ces pics froid et chaud.

**Graphiques** :
```{r Q13 froid, echo=FALSE}
filtrer_dates <- function(dates) {
  df_meteo %>%
    filter(date %in% ymd(dates))
}

period_tempextreme_froid_dec22 <- c("2022-12-25", "2022-12-24", "2022-12-23")
period_tempextreme_froid_fev21 <- c("2021-01-29", "2021-01-30", "2021-01-31", "2021-02-01", "2021-02-02", "2021-02-03")

period4semaines_tempextreme_froid_fev21 <- format(seq(min(ymd(period_tempextreme_froid_fev21)) - days(14), 
                                               max(ymd(period_tempextreme_froid_fev21)) + days(14), 
                                               by = "day"), "%Y-%m-%d")
period4semaines_tempextreme_froid_dec22 <- format(seq(min(ymd(period_tempextreme_froid_dec22)) - days(14), 
                                               max(ymd(period_tempextreme_froid_dec22)) + days(14), 
                                               by = "day"), "%Y-%m-%d")


df_tempextreme_froid_dec22 <- filtrer_dates(period4semaines_tempextreme_froid_dec22)
df_tempextreme_froid_fev21 <- filtrer_dates(period4semaines_tempextreme_froid_fev21)


#Visualisation 1 temp extreme froide
plotQ13_froid1 <- ggplot(df_tempextreme_froid_dec22, aes(x = date, y = nb_trajets)) +
  geom_col(aes(fill = ifelse(date %in% period_tempextreme_froid_dec22, "Période froide", "Période normale"))) +
  geom_smooth(data = df_tempextreme_froid_dec22, method = "loess", se = FALSE, aes(color = "Courbe moyenne")) +
  labs(title = "Observation des nombres de trajets par jour lors de températures extrêmes froides en décembre 2022",
    x = "Date", y = "Nombre de trajets par jour") +
  scale_fill_manual(values = c("Période froide" = "blue", "Période normale" = "grey"), name = NULL) +
  scale_color_manual(values = c("Courbe moyenne" = "red"), name = NULL) +
  theme_minimal()

#Visualisation 2 temp extreme froide
plotQ13_froid2 <- ggplot(df_tempextreme_froid_fev21, aes(x = date, y = nb_trajets)) +
  geom_col(aes(fill = ifelse(date %in% period_tempextreme_froid_fev21, "Période froide", "Période normale"))) +
  geom_smooth(data = df_tempextreme_froid_fev21, method = "loess", se = FALSE, aes(color = "Courbe moyenne")) +
  labs(title = "Observation des nombres de trajets par jour lors de températures extrêmes froides en février 2021",
    x = "Date", y = "Nombre de trajets par jour") +
  scale_fill_manual(values = c("Période froide" = "blue", "Période normale" = "grey"), name = NULL) +
  scale_color_manual(values = c("Courbe moyenne" = "red"), name = NULL) +
  theme_minimal()

plotQ13_froid1
plotQ13_froid2

```
**Interprétation**
La première visualisation est faite sur 14 jours précédant et 14 jours suivant l'évènement en décembre 2022. Grâce à un barplot, on peut observer le nombre de trajet cumulé chaque jour ainsi que sa courbe de régression en rouge. La période de l'évènement est mis en valeur en colorant en bleu les barres la concernant. On voit une grosse chute d'utilisation par 4 si l'on compare avec les jours précédent. Cependant on remarque aussi que les jours juste avant et après l 'évènement suivent la même tendance. Ceci peut s'expliquer parce que les températures du 22 décembre (veille de l'évènement choisi) a déja atteint ...°C, une différence de ... °C avec le jour d'après.

La seconde visualisation est faite sur 14 jours précédant et 14 jours suivant l'évènement en février 2021. On peut voir que les deux premiers jours n'ont pas tellement d'impact sur l'utilisation des vélos, mais à partir du 3ème. On voit une réelle chute pendant 3 jours, qui ensuite remonte le dernier jour.

**Hypothèse**

Nous cherchons maintenant à voir l'impact que ces températures extrêmes chaudes auraient pu avoir sur l'utilisation des vélos.

En second temps nous verrons l'impact de 2 évènements à température chaudes extrêmes.

Pour les évènements chaud, nous en avons choisi un en mai 2022, et l'autre en juillet 2024:
En mai 2022, Washington D.C. a connu une vague de chaleur marquante, enregistrant des températures exceptionnellement élevées pour cette période de l'année. Selon les prévisions de la National Weather Service, les températures ont commencé à grimper rapidement, atteignant des niveaux rarement observés si tôt dans la saison.
Source :https://www.washingtonpost.com/weather/2022/05/19/dc-may-heat-wave-record/

En juillet 2024, Washington D.C. a subi une vague de chaleur particulièrement intense qui a marqué l'un des mois de juillet les plus chauds jamais enregistrés.Lors de cette vague de chaleur, la température a atteint 39 °C le 15 juillet, établissant un nouveau record pour cette date.
Source : https://www.washingtonpost.com/weather/2024/07/16/dc-heat-100-record-high-temperatures/

On peut supposer que le même effet de baisse d'utilisation des vélos aura lieu durant les pics de chaleur.

**Graphiques**

```{r Q13 chaud, echo=FALSE}
filtrer_dates <- function(dates) {
  df_meteo %>%
    filter(date %in% ymd(dates))
}
period_tempextreme_chaud_may22 <- c("2022-05-20", "2022-05-21", "2022-05-22")
period_tempextreme_chaud_july24 <- c("2024-07-14", "2024-07-15", "2024-07-16", "2024-07-17", "2024-07-18")

period4semaines_tempextreme_chaud_may22 <- format(seq(min(ymd(period_tempextreme_chaud_may22)) - days(14), 
                                               max(ymd(period_tempextreme_chaud_may22)) + days(14), 
                                               by = "day"), "%Y-%m-%d")
period4semaines_tempextreme_chaud_july24 <- format(seq(min(ymd(period_tempextreme_chaud_july24)) - days(14), 
                                               max(ymd(period_tempextreme_chaud_july24)) + days(14), 
                                               by = "day"), "%Y-%m-%d")
df_tempextreme_chaud_may22 <- filtrer_dates(period4semaines_tempextreme_chaud_may22)
df_tempextreme_chaud_july24 <- filtrer_dates(period4semaines_tempextreme_chaud_july24)

#Visualisation 3 temp extreme chaude may22
plotQ13_chaud1 <- ggplot(df_tempextreme_chaud_may22, aes(x = date, y = nb_trajets)) +
  geom_col(aes(fill = ifelse(date %in% period_tempextreme_chaud_may22, "Période chaude", "Période normale"))) +
  geom_smooth(data = df_tempextreme_chaud_may22, method = "loess", se = FALSE, aes(color = "Courbe moyenne")) +
  labs(title = "Observation des nombres de trajets par jour lors de températures extrêmes chaudes en mai 2022",
    x = "Date", y = "Nombre de trajets par jour") +
  scale_fill_manual(values = c("Période chaude" = "blue", "Période normale" = "grey"), name = NULL) +
  scale_color_manual(values = c("Courbe moyenne" = "red"), name = NULL) +
  theme_minimal()


#Visualisation 4 temp extreme chaude july24
plotQ13_chaud2 <- ggplot(df_tempextreme_chaud_july24, aes(x = date, y = nb_trajets)) +
  geom_col(aes(fill = ifelse(date %in% period_tempextreme_chaud_july24, "Période chaude", "Période normale"))) +
  geom_smooth(data = df_tempextreme_chaud_july24, method = "loess", se = FALSE, aes(color = "Courbe moyenne")) +
  labs(title = "Observation des nombres de trajets par jour lors de températures extrêmes chaudes en juillet 2024",
    x = "Date", y = "Nombre de trajets par jour") +
  scale_fill_manual(values = c("Période chaude" = "blue", "Période normale" = "grey"), name = NULL) +
  scale_color_manual(values = c("Courbe moyenne" = "red"), name = NULL) +
  theme_minimal()


plotQ13_chaud1
plotQ13_chaud2
```
**Interprétation**

La première visualisation est faite sur 14 jours précédant et 14 jours suivant l'évènement en mai 2022. Grâce à un barplot, on peut observer le nombre de trajet cumulé chaque jour ainsi que sa courbe de régression en rouge. La période de l'évènement est mis en valeur en colorant en bleu les barres la concernant. A l'inverse des périodes froides, on voit une réaction totalement inverse. Les utilisateurs ne diminuent pas du tout et reste les mêmes, malgré des chaleurs avoisinant les ...°C.

La seconde visualisation est faite sur 14 jours précédant et 14 jours suivant l'évènement en juillet 2024. 

### Question 15 : Les utilisateurs membres utilisent-ils plus les vélos par mauvais temps ?

**Hypothèse**

On se demande si les utilisateurs membres utilisent plus les vélos par mauvais temps.
Nous aurions tendance à dire que oui, que les utilisateurs casual les utilisent pendant des périodes de beau temps pour faire des balades tandis que les utilisateurs membre les utilisent pour se déplacer quotidiennement, ce qui peut inclure davantage de trajets sous le mauvais temps.

```{r}

df <- df %>%
  mutate(
    date = as.Date(started_at),
    member_casual = as.factor(member_casual)
  )

weather <- weather %>%
  mutate(
    date = as.Date(datetime),
    bad_weather = precip > 1 | windspeed > 25
  )

daily_counts <- df %>%
  group_by(date, member_casual) %>%
  summarise(n_trips = n(), .groups = "drop")


merged <- daily_counts %>%
  left_join(weather, by = "date")

merged %>%
  group_by(bad_weather, member_casual) %>%
  summarise(mean_rides = mean(n_trips), .groups = "drop") %>%
  ggplot(aes(x = bad_weather, y = mean_rides, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Utilisation moyenne selon météo",
    x = "Météo mauvaise",
    y = "Nombre moyen de trajets",
    fill = "Type d'utilisateur"
  ) +
  theme_minimal()


merged %>%
  group_by(member_casual, bad_weather) %>%
  summarise(total = sum(n_trips), .groups = "drop") %>%
  group_by(member_casual) %>%
  mutate(share = total / sum(total) * 100) %>%
  ggplot(aes(x = member_casual, y = share, fill = bad_weather)) +
  geom_col(position = "stack") +
  labs(
    title = "Part des trajets en mauvais temps",
    x = "Type d'utilisateur",
    y = "Pourcentage des trajets",
    fill = "Mauvais temps"
  ) +
  theme_minimal()

```

**Interprétation**

Sur ce graphique, nous avons représenté les jours de mauvais temps par les jours où il y a soit plus de 1mm de précipitation soit plus de 25km/h de vent.\
On peut voir que contrairement à nos hypothèses que le mauvais temps affecte quasiement autant les utilisateurs réguliers que les utilisateurs occasionnels.
On peut voir également que finalement, les utilisateurs en règle générale ne sont pas très affectés par la météo, environ 45% des trajets sont réalisés sous mauvais temps.


## Question bonus 

### Question 16 : Est-ce qu'il est possible de voir une différence d'utilisation des vélos lors de la prise du Capitol le 6 janvier 2021 ? 

**Hypothèse**

Dans la matinée du mercredi 6 janvier, les manifestants encerclent le Washington Monument et se rassemblent pour assister à des discours prononcés par Rudy Giuliani, conseiller de Trump, et par Trump lui-même. Il a réitéré des allégations infondées de fraude électorale et a exhorté ses partisans à marcher vers le Capitole, déclarant : "battons-nous comme des diables". En réponse, des milliers de manifestants ont convergé vers le Capitole (13h10), franchissant les barrières de sécurité et pénétrant dans le bâtiment (14h). Les forces de l'ordre, en sous-effectif, ont été rapidement débordées et le capitole a été mis en confinement. A 14h48, le maire de Washington déclare un couvre-feu dans toute la ville. Ainsi on essaye alors de savoir s'il est possible de voir une différence d'utilisation des vélos lors de la prise du Capitole.
On peut imaginer qu'à partir de l'information du couvre feu, les gens partirent rapidement de leur travail pour rentrer.

Source : 
https://fr.euronews.com/2022/01/06/l-assaut-du-capitole-retour-sur-le-deroule-de-cette-journee-noire-pour-la-democratie-ameri
https://edition.cnn.com/2022/07/10/politics/jan-6-us-capitol-riot-timeline
https://edition.cnn.com/interactive/2021/01/politics/us-capitol-siege/

**Graphique 1**
On souhaite d'abord voir sur l'ensemble de la journée s'il y a eu plus d'utilisation que les jours précédents et suivants le 6 janvier
```{r Q18, echo=FALSE}
filtrer_dates <- function(dates) {
  df_meteo %>%
    filter(date %in% ymd(dates))
}

date_prise_capitole <- "2021-01-06"

period4semaines_prise_capitole <- format(seq(min(ymd(date_prise_capitole)) - days(14), 
                                               max(ymd(date_prise_capitole)) + days(14), 
                                               by = "day"), "%Y-%m-%d")

df_prise_capitole <- filtrer_dates(period4semaines_prise_capitole)

#Visualisation 1 temp extreme froide
ggplot(df_prise_capitole, aes(x = date, y = nb_trajets)) +
  geom_col(aes(fill = ifelse(date %in% date_prise_capitole, "Prise Capitole", "Période normale"))) +
  geom_smooth(data = df_prise_capitole, method = "loess", se = FALSE, aes(color = "Courbe moyenne")) +
  labs(title = "Observation des nombres de trajets par jour lors de la prise du Capitole",
    x = "Date", y = "Nombre de trajets par jour") +
  scale_fill_manual(values = c("Prise Capitole" = "blue", "Période normale" = "grey"), name = NULL) +
  scale_color_manual(values = c("Courbe moyenne" = "red"), name = NULL) +
  theme_minimal()




```
**Interprétation**
La visualisation est faite sur 14 jours précédant et 14 jours suivant le 6 janvier. Grâce à un barplot, on peut observer le nombre de trajet cumulé chaque jour ainsi que sa courbe de régression en rouge. 
On observe aucun changement apparent dans l'utilisation quotidienne des vélos le 6 janvier. 


**Hypothèse**
Cependant on peut supposer que l'assaut du Capitole a entraîné une augmentation de l'utilisation des vélos autour du Capitole et du parc The Ellipse, où Donald Trump a prononcé son discours. (lieu du speech de Donald Trump). On peut donc s'intéresser à l'activité par station pour repérer des hausses à partir de ce moment là.
On qualifie les augmentations par une fréquentation supérieure à la normale.

On commence la visualisation à partir du moment où les manifestants partent du Washington Monument et marchent sur la Pennsylvania Avenue (13h10) jusqu'à rejoindre le Capitole. Les premières intrusions dans le bâtiment ont lieu vers 14h. Un couvre feu est annoncé à 14h48 et mis en place à 18h, fin de la visualisation. 

**Graphique 2**
```{r Q18 bis, echo=FALSE}
# Dates à comparer
date_capitole <- "2021-01-06"   
date_reference <- "2021-01-13"  

# Fonction simplifiée pour extraire les données essentielles
analyser_journee <- function(date) {
  df %>%
    filter(as.Date(started_at) == as.Date(date)) %>%
    mutate(heure_minute = hour(started_at) + minute(started_at)/60) %>%
    filter(!is.na(start_lat), !is.na(start_lng), !is.na(start_station_name),
           heure_minute >= 13.2, heure_minute < 18) %>%  # Période critique uniquement
    group_by(start_station_name) %>%
    summarise(
      trajets = n(),
      start_lat = median(start_lat),
      start_lng = median(start_lng),
      .groups = "drop"
    )
}

# Analyser les deux journées
capitole <- analyser_journee(date_capitole)
reference <- analyser_journee(date_reference)

# Comparaison directe - EXCLURE L'ACTIVITÉ RÉDUITE
comparaison <- capitole %>%
  inner_join(reference, by = "start_station_name", suffix = c("_cap", "_ref")) %>%
  mutate(
    diff_relative = (trajets_cap - trajets_ref) / pmax(trajets_ref, 1) * 100,
    # Créer la variable scaled pour l'échelle continue
    diff_relative_scaled = pmax(diff_relative, 0),  # Minimum à 0 pour l'échelle
    anomalie = case_when(
      diff_relative >= 50 ~ "Anomalie forte",
      diff_relative >= 25 ~ "Anomalie modérée", 
      TRUE ~ "Normal"
    )
  ) %>%
  filter(trajets_cap >= 3 | trajets_ref >= 3,    # Seuil minimal
         diff_relative > -25) %>%                  # EXCLURE activité réduite
  arrange(desc(diff_relative))

# Palette couleurs continue - Échelle de bleus
palette_continue <- colorNumeric(
  palette = c("#f7fbff", "#deebf7", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#08519c", "#08306b"),
  domain = c(0, max(comparaison$diff_relative_scaled, na.rm = TRUE))
)

# Carte
map_comparison <- leaflet(comparaison) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Capitole
  addMarkers(lng = -77.0090, lat = 38.8899, popup = "Capitole des États-Unis") %>%
  addMarkers(lng = -77.035507, lat = 38.894207, popup = "The Ellipse (parc)") %>%
  
  # Stations avec échelle continue
  addCircleMarkers(
    lng = ~start_lng_cap, lat = ~start_lat_cap,
    color = ~palette_continue(diff_relative_scaled),        # Utiliser palette_continue
    fillColor = ~palette_continue(diff_relative_scaled),    # Utiliser palette_continue
    radius = ~pmax(4, abs(diff_relative)/15 + 3),
    fillOpacity = 0.8,
    stroke = TRUE,
    weight = 1,
    popup = ~paste0(
      "<b>", start_station_name, "</b><br/>",
      "6 jan: ", trajets_cap, " trajets<br/>",
      "13 jan: ", trajets_ref, " trajets<br/>",
      "Différence: ", round(diff_relative, 1), "%<br/>",
      "Statut: ", anomalie
    )
  ) %>%
  
  # Légende avec échelle continue
  addLegend(
    position = "bottomright",
    pal = palette_continue,                    # Utiliser palette_continue
    values = ~diff_relative_scaled,            # Utiliser diff_relative_scaled
    title = "Augmentation (%)",
    labFormat = labelFormat(suffix = "%")
  ) %>%
  
  # Titre
  addControl(
    html = "<h3>6 janvier vs 13 janvier 2021<br/>Période 14h48-18h<br/><small>Échelle continue de bleus</small></h3>",
    position = "topleft"
  )


# Afficher la carte
map_comparison
```

**Interprétation**
Cette visualisation interactive montre uniquement les augmentations d’utilisation des stations de vélos en libre-service à Washington, DC, entre deux mercredis consécutifs : le 6 janvier 2021 (jour de l’assaut du Capitole) et le 13 janvier 2021, durant la même tranche horaire critique : 13h10 à 18h. 

Seules les stations ayant enregistré une activité significative (au moins 3 trajets sur l’une ou l’autre des journées) sont prises en compte. Les stations ayant connu une forte baisse sont exclues pour se concentrer sur les hausses anormales.
Pour chaque station, la variation de trafic est calculée en pourcentage par rapport au volume référent du 13 janvier.
Échelle continue de bleus : plus l'augmentation du trafic est forte, plus la couleur de la station est foncée, et plus le cercle est large.
Un clic sur un cercle affiche les trajets enregistrés pour chacun des deux jours, le pourcentage de variation, et le statut d’anomalie.
Les emplacements du Capitole et du Washington Monument sont signalés pour repérer les zones d’intérêts principales.

On peut observer que les stations au nord de la Pennsylvania Avenue (avenue utilisée par les manifestants) ont des utilisations qui ont augmentées comparé à la normale. Les 3 stations avec les plus grosses augmentations autour de l'avenue sont "17th & G St NW", "10th & G St NW", et "4th & D St NW / Judiciary Square".
En voyant la visualisation on remarque qu'il existe des augmentations inhabituelles autour de l'avenue potentiellement lié à la manifestation mais cependant il est difficile d'établir un lien direct.


## Conclusion

