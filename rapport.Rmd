---
title: "Analyse de l'utilisation des vélos libre-service à Washington"
author: "Julien Schieler, Icham Lecorvaisier, Mathis Reslinger, Lila Mortier"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

# Analyse de l’utilisation des vélos libre-service à Washington

Julien Schieler, Icham Lecorvaisier, Mathis Reslinger, Lila Mortier

## Introduction

### Données

Nous utilisons 4 jeux de données pour analyser l’utilisation des vélos libre-service à Washington :

**Information sur les locations de vélos** (source :https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv)

- **Nom du dataset :** daily_rent_detail.csv
- **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre service de Washington.
- **Pourquoi ces données ?** Elles permettent d’observer l’utilisation de ces vélos, en analysant les dates et heures d’utilisation, les lieux d’emprunt et de dépôt notamment.
- **Nombre d’observations** : 16 086 673
- **Nombre de colonnes** : 13 colonnes incluant :
    - Identifiant du trajet (”ride_id”)
    - Type du vélo (”rideable type”) : vélo classique, électrique, autre (cargo)
    - Date et heure de l’emprunt (”started_at”)
    - Date et heure du retour (”ended_at”)
    - Nom de la station de départ (”start_station_name”)
    - Identifiant de la station de départ (”start_station_id)
    - Nom de la station d’arrivée (”end_station_name”)
    - Identifiant de la station d’arrivée (”end_station_id”)
    - Latitude de départ (”start_lat”)
    - Longitude de départ (”start_lng”)
    - Latitude d’arrivée (”end_lat”)
    - Longitude d’arrivée (”end_lng”)
    - Type d’abonnement du client (”member_casual”) : utilisateur en abonnement casual ou membre.
- **Créateur et éditeur** : Entreprise Capital Bike Share
- **Format** : CSV
- **Sous-groupes** :
    - Type de vélo : vélo classique, électrique et cargo
    - Type d’utilisateur : occasionnel et membre
    - Stations : possibilité d’analyser par station d’origine ou de destination
    - Périodes temporelles : heures, jours, saisons, etc…

 
**Liste des stations de Washington** (source :https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv)

- **Nom du dataset :** station_list.csv
- **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre-service de Washington.
- **Pourquoi ces données ?** Elles permettent d’avoir la liste des stations à Washington
- **Nombre d’observations :** 912 stations différentes
- **Nombre de colonnes :** 2 colonnes incluant **:**
    - Nom de la station
    - Identifiant de la station
- **Format :** CSV
- **Sous-groupes** :
    - Catégorisation géographique (ex: quartiers)


**Emprunts et dépôts des vélos par station** (source :https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=station_list.csv)

- **Nom du dataset :** usage_frequency.csv
- **Origine des données** : Ces données proviennent de l’entreprise Capital Bike Share, l’entreprise de location de vélos libre-service de Washington.
- **Pourquoi ces données ?** Elles permettent d’avoir le nombre d’emprunt et de dépôt pour chaque station à Washington
- **Nombre d’observations :** 873 318
- **Nombre de colonnes :** 4 colonnes incluant **:**
    - Date
    - Nom de la station
    - Nombre d’emprunt sur cette station
    - Nombre de dépôt sur cette station
- **Format :** CSV
- **Sous-groupes** :
    - Date
    - Stations : possibilité d’analyser par stations
    - Activité : Emprunt et dépôt
    - Utilisation : stations très utilisées et peu utilisées

**Météo (source :** https://www.kaggle.com/datasets/taweilo/capital-bikeshare-dataset-202005202408?select=weather.csv)

- **Nom du dataset :** weather.csv
- **Origine des données** : Ces données proviennent de l’entreprise Visual Crossing qui est un service de météo de Virginia aux Etats Unis.
- **Pourquoi ces données ?** Elles permettent d’obtenir la météo de chaque jour afin de pouvoir croiser ces données avec l’utilisation des vélos à Washington
- **Nombre d’observations :** 1584, une pour chaque jour entre mai 2020 et août 2024
- **Nombre de colonnes :** 32 colonnes dont 7 que nous allons utiliser **:**
    - Date (”*datetime”*)
    - Moyenne de température sur la journée (”*temp*”)
    - Moyenne de température ressentie sur la journée (”*feelslike*”)
    - Précipitations (”*precip*”) : quantité de liquide tombé / prévu dans la période
    - Epaisseur de neige au sol (”*snowdepth*”)
    - Couverture nuageuse (”*cloudcover*”) : entre 0 et 100%
    - Vitesse du vent (”*windspeed*”) : vitesse moyenne du vent soutenu, mesurée comme la vitesse moyenne du vent survenant au cours de la à deux minutes précédentes
- **Créateur et éditeur** : Visual Crossing (fournisseur de données météorologiques)
- **Format :** CSV
- **Sous-groupes** :
    - Conditions météorologiques : pluie, neige, vent, etc…
    - Températures : froid, tempéré, chaud
    - Saisons : printemps, été, automne, hiver
    - Jours : semaine ou week-end


### Plan d’analyse

Avant de commencer l'analyse, nous nous posons plusieurs questions que l’on peut catégoriser :

1. Questions exploratoires
    1. Utilisation générale
        - Quelle est la tendance générale de l’utilisation des vélos au cours de l’année ? Y a-t-il des pics saisonniers ?\
        **Graphique :** Lineplot du nombre de trajet en fonction du temps\
        **Variables :** Nombre de trajets, date
        - Combien de trajets sont effectués en moyenne par jour/mois ?\
        **Graphique :** barplot du nombre de trajets par jour de la semaine, par mois de l’année\
        **Variables :** Nombre de trajets, date d’emprunt
        - Quelles stations sont les plus utilisées pour les départs/arrivées ?\
        **Graphique :** Carte avec points de taille différentes pour le nombre de départs/arrivées\
        **Variables :** Nom des stations, Nombre de départs/arrivées, Coordonnées des stations
        - Quel type de vélo (électrique, classique ou cargo) est le plus utilisé ?\
        **Graphique :** Barchart avec pourcentage/nombre de vélos par catégorie\
        **Variables :** Type de vélo, Nombre de trajets par type de vélos
        - Quel est le comportement moyen selon le type d’utilisateur (occasionnel ou membre) ?\
        **Graphique :** Radar chart (potentiellement plusieurs)\
        **Variables :** moyenne de durée de trajet, distance, heure d’emprunt et de dépôt, date (jour de la semaine), type d’abonnement, type de vélo
        - Quelles sont les durées moyenne des trajets ? Varient-elles selon le jour de la semaine ou la météo ?\
        **Graphique :** Boxplot ou violin plot\
        **Variables :** Durée du trajet, type d’utilisateur, date, condition météo
        - Les vélos électriques sont-ils plus prisés pendant les heures de pointe ?\
        **Graphique :** Bar plot des différents types de vélo\
        **Variables :**  Type du vélo, Date
    2. Spatio-temporel
        - Quelles stations sont les plus actives à différentes périodes de la journée (matin ou soir) ?\
        **Graphique :** Heatmap avec X= heure, Y = station et couleur = nombre de trajets\
        **Variables :** Heure, Nom de la station, Nombre de trajets
        - Quelles sont les stations les plus utilisées le week-end, en semaine ?\
        **Graphique :** Stacked barplot\
        **Variables :** Jour de la semaine, nom station, nombre de trajets
        - Existe-t-il des stations avec un fort déséquilibre entre départs et arrivées ?\
        **Graphique :** Barplot (différence départ, arrivée)\
        **Variables :** Nom de la station, Nombre de départs/arrivées
        - Quels sont les trajets les plus fréquents (station de départ vers station d’arrivée) ?\
        **Graphique :** Barplot (top 10 des paires de stations les plus fréquentées)\
        **Variables :** Nom de la station de départ, Nom de la station d’arrivée, Nombre de trajets

2. Questions explicatives
    1. Lien entre météo et usage
        - Comment la météo influence-t-elle l’usage des vélos ? (pluie, température, vent, etc…)\
        **Graphique :** Lineplot ou scatterplot par variable météorologique\
        **Variables :** Conditions météo, Nombre de trajet par jour
        - En cas de météo extrême (fortes pluies ou froid extrême), est-ce que le volume de trajets diminue fortement ?\
        **Graphique :** Boxplot (jours normaux vs météo extrême)\
        **Variables :** Conditions météo, nombre de trajets
        - Quel est l’impact de la neige ou du vent ou de la couverture nuageuse sur la durée moyenne des trajets ?\
        **Graphique :** Lineplot ou scatterplot par variable météorologique\
        **Variables :** Conditions météo, Durée moyenne des trajets
    2. Différences selon les utilisateurs
        - Les membres abonnés utilisent-ils plus les vélos que les usagers occasionnels quand il fait mauvais ?\
        **Graphique :** Lineplot avec comparaison entre les types d’utilisateur\
        **Variables :** météo, nombre de trajet, type d’utilisateur
        - Selon les saisons, la fréquence de cyclistes occasionnels change-t-elle comparé aux membres ?\
        **Graphique :** Lineplot par type d’utilisateur\
        **Variables :** nombre de trajets, type d’utilisateurs, mois
    3. Temporalité
        - En se focalisant sur les utilisateurs, y a-t-il des effets “heures de pointe” dans la journée ?\
        **Graphique :** Lineplot (heure en abscisse et nombre de trajets en ordonnée)\
        **Variables :** nombre de trajets, heure
    4. Évènements
        - Est ce qu’il est possible de voir une différence d’utilisation des vélos lors de la prise du Capitol le 6 janvier 2021?\
        **Graphique :** Lineplot (date en abscisse, nombre de trajets en ordonnée, avec mise en évidence du 6 janvier 2021)\
        **Variables :** Date de début du trajet, Nombre de trajets par jour

### Contraintes et limites :
- **Données agrégées** : L'absence d’identifiant unique pour chaque vélo limite les possibilités de reconstitution précise des itinéraires ou des distances parcourues.
- **Données contextuelles limitées** : Les événements exceptionnels (grèves, manifestations, travaux, etc.) ou les changements d’infrastructure (nouvelles pistes cyclables, réaménagements urbains) ne sont pas pris en compte dans les données disponibles.
- **Intention de l’usager** : bien qu’il soit riche en information, les jeux de données ne reflète pas nécessairement les raisons des choix des usagers (par ex: s’il n’y a plus de vélos électriques disponibles, l’usager va être contraint de prendre un vélo classique contre son gré)

L’objectif est d’aboutir à une compréhension approfondie de la pratique du cyclisme à Washington à partir de ces jeux de données, en identifiant les tendances d’usage, les comportements des usagers, et les facteurs (comme la météo ou la localisation des stations) influençant l’utilisation du service. Cette analyse vise à fournir des insights pertinents pour les décideurs publics, les urbanistes, les acteurs de la mobilité durable, ainsi que pour les citoyens investis dans l’amélioration des mobilités douces.

## Partie Exploration

### Importation du jeu de données et des librairies

```{r Importation_Packages, echo=FALSE, include=FALSE}
library(readr)
library(ggplot2); 
library(dplyr); 
library(lubridate);
require('utils')

```

```{r}
#importation du jeu de données
df <- 
weather <-
```
## Question 1

**Hypothèse** :

En premier lieu, une observation intéressante à faire est d’observer la tendance générale de l’utilisation des vélos  au cours des années étudiées.  Nous pouvons imaginer une corrélation avec la température pour représenter les saisons, et l’utilisation des vélos. 

**Graphique** :

```{r}
#Préparation des données
# Nombre trajets par semaine
df$date <- as.Date(df$started_at)

df_semaine <- df %>%
  mutate(semaine = floor_date(date, "week", week_start = 1)) %>%
  group_by(semaine) %>%
  summarise(nombre_trajets_semaine = sum(n()))

#Température moyenne par semaine
weather_semaine <- weather %>%#
  mutate(semaine = floor_date(datetime, "week", week_start = 1)) %>%
  group_by(semaine) %>%
  summarise(temp = mean(temp, na.rm = TRUE))

#Facteur d'agrandissement Nombre trajet / Température
facteur_trajet_temperature <- max(df_semaine$nombre_trajets_semaine, na.rm = TRUE) / max(weather_semaine$temp, na.rm = TRUE)

# Visualisation
ggplot() +
  geom_line(data = df_semaine,
            aes(x = semaine, y = nombre_trajets_semaine),
            color = "black") +
  geom_smooth(data = weather_semaine,
              aes(x = semaine, y = temp * facteur_trajet_temperature),
              color = "lightcoral",
              method = "loess",
              span= 0.2,) +
  scale_y_continuous(
    name = "Nombre de trajets",
    sec.axis = sec_axis(~ . / facteur_trajet_temperature, name = "Température (°C)") ) +
  labs(title = "Nombre de trajets par semaine et température",
       x = "Date",
       subtitle = "Trajets (noir) et température (rouge)") +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.title.y.right = element_text(color = "red")
  )
```
**Interprétation** :

Nous constatons une augmentation au fil des années de l’utilisation des vélos et surtout une cyclicité. Nous observons une corrélation très forte entre la température et l’utilisation des vélos. Les utilisateurs privilégient l’utilisation des vélos lors de températures chaudes. Ainsi, nous pouvons voir que les utilisations majoritaires se font pendant le printemps, l’été et l’automne. 

Certaines semaines ne suivent pas le paterne comme la semaine du 3 janvier 2022. Avec une température moyenne de 0°, l’utilisation du vélo est la plus faible du dataset avec 15 083 utilisations. Ceci peut s’expliquer par une chute de neige tombée le 3 janvier où 17,5 cm sont tombés en une journée. 
On observe des phénomènes similaires lors de la semaine du 19 décembre 2022, en raison de conditions météorologiques défavorables comprenant des grelons, de la neige et de la pluie. Pendant la semaine du 15 janvier 2024, on observe une chute de température importante, passant de 7°C la semaine précédente à -2,5°C. Cette semaine-là, on enregistre également des grelons, de la neige et de la pluie, ce qui contribue à une utilisation réduite des vélos.

Ces exemples nous amène à nous demander si une corrélation forte peut être associée entre la météo et l’utilisation des vélos.

### Question 2

#### Question 2a : Y a-t-il une variation du nombre de trajets selon les jours de la semaine ?

**Traitement des données pour les questions 2a et 2b** :

Pour cette analyse, nous avons choisi de ne conserver que la variable started_at, qui indique le moment précis où chaque vélo a été emprunté. À partir de cette information temporelle, nous avons dérivé d’autres variables selon les questions que nous souhaitions étudier :

* Pour la question 2a, nous avons utilisé la fonction wday() du package lubridate afin d’extraire le jour de la semaine correspondant à chaque date.
* Pour la question 2b, nous avons extrait le mois grâce à la fonction month().

Ces transformations nous ont permis de comprendre l’évolution du nombre d’emprunts selon les moments de la semaine ou de l’année.

**Hypothèse** :

Nous imaginons que les utilisateurs empruntent davantage les vélos en semaine (pour se rendre au travail notamment) que le week-end.

**Graphique** :
```{r}
# Préparation des données
avg_rides_per_day <- df %>%
  transmute(day_of_week = wday(started_at, label = TRUE, abbr = FALSE, week_start = 1), date = as_date(started_at)) %>% # on garde la date et le jour correspondant
  group_by(date, day_of_week) %>% # un groupe = une date unique avec son jour
  summarise(daily_count = n(), .groups = "drop") %>%
  group_by(day_of_week) %>%
  summarise(avg_per_day = mean(daily_count))

# Visualisation
avg_rides_per_day %>%
  ggplot(aes(x = day_of_week, y = avg_per_day)) +  geom_col(fill = "blue") +
  labs(title = "Nombre moyen de trajets par jour de la semaine",
       x = "Jour de la semaine",
       y = "Nombre moyen de trajets") +
  scale_y_continuous(breaks = seq(6000, 12000, by = 1000)) +
  coord_cartesian(ylim = c(6000, NA)) + # Limite inférieure à 6000 
  theme_minimal()
```

**Interprétation** :

Contrairement à notre hypothèse initiale, les week-ends enregistrent en réalité un nombre très élevé de trajets, en particulier le samedi qui dépasse tous les autres jours de la semaine.
Cela suggère que l’usage du vélo ne se limite pas à une fonction utilitaire (travail), mais qu’il est aussi très utilisé pour les loisirs.
Le dimanche reste élevé, presque équivalent aux jours de travail.

En semaine, le nombre de trajets reste relativement stable autour de 10 000 trajets par jour.
Cependant, on observe une baisse notable le lundi, où la moyenne descend à environ 9 000 trajets.
Cela peut s’expliquer par le fait que de nombreux commerces, établissements culturels ou services (comme les banques) sont souvent fermés le lundi, ce qui réduit potentiellement le besoin de déplacement.

Cette observation pourrait être affinée par une analyse horaire (Les pics du matin et du soir existent-ils en semaine ?) et une analyse des catégories d'usagers (membres ou occasionnels)

#### Question 2b : Y a-t-il une variation du nombre de trajets selon les mois de l’année ?

**Hypothèse** :

Nous supposons que la fréquentation des vélos est plus importante en été, en raison du beau temps, et qu’elle diminue pendant les mois froids et pluvieux.

**Graphique** :
```{r}
# Préparation des données
avg_rides_per_month <- df %>%
  transmute(months = month(started_at, label = TRUE, abbr = FALSE), date = as_date(started_at)) %>% # on garde la date et le mois correspondant
  group_by(date, months) %>% # un groupe = une date unique avec son mois
  summarise(monthly_count = n(), .groups = "drop") %>%
  group_by(months) %>%
  summarise(avg_per_month = mean(monthly_count))

# Visualisation
avg_rides_per_month %>%
  ggplot(aes(x = months, y = avg_per_month)) +  geom_col(fill = "blue") +
  labs(title = "Nombre moyen de trajets par mois de l'année",
       x = "Mois",
       y = "Nombre moyen de trajets") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

**Interprétation** :

Le nombre moyen de trajets évolue clairement au rythme des saisons.

L’activité augmente fortement entre avril et septembre, avec un pic en juillet-août où l'on atteint près de 13 000 trajets en moyenne. Cette hausse s’explique sans doute par les vacances estivales et des conditions météorologiques plus favorables.

À l'inverse, les trajets diminuent nettement en hiver, notamment entre décembre et février, où le nombre moyen redescend autour de 5 000 trajets en décembre. Cette baisse reflète un usage moindre du vélo durant les mois les plus froids de l'année.


### Question 4 : Evolution de l'usage des différents types de vélos

**Quelle est l'évolution de l'usage des différents type de vélos ?**

On peut supposer une hausse de l'utilisation de vélos électriques.

```{r}

monthly_usage <- df %>%
  mutate(month = floor_date(as.Date(started_at), unit = "month")) %>%
  group_by(month, rideable_type) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# Lineplot
ggplot(monthly_usage, aes(x = month, y = nb_trajets, color = rideable_type)) +
  geom_line(size=1) +
  labs(
    title = "Évolution mensuelle du nombre d'utilisations par type de vélo",
    x = "Mois",
    y = "Nombre de trajets",
    color = "Type de vélo"
  ) +
  scale_y_continuous(labels = scales::comma)
```

**Interprétation**

L'évolution mensuelle du nombre d'utilisations par type de vélos permet de montrer plusieurs tendances intéressantes. On peut tout d'abord voir que les vélos « docked » c'est-à-dire les vélos qui se prennent et rendent à des stations ont été les plus populaires avant 2021 mais ont connu une grosse diminution au profit de vélos « classiques ». Ces vélos peuvent être posés et rendus n'importe où et ne nécessitent pas d'être rattachés à une station. Ensuite entre 2021 et 2024, le vélo classique a été largement le plus utilisé avant d'être dépassé par les vélos « électriques » qui ont connu une hausse significative à partir de 2023. Ce graphique montre également que l'utilisation des vélos suit un cycle saisonnier, aspect qui sera détaillé dans une autre visualisation. Ces données suggèrent une modernisation de la flotte de Capital Bike Share, et une transition des utilisateurs vers des vélos plus confortables qui demandent moins d'efforts (électriques) ainsi que des vélos qui leur permettent plus de flexibilité en terme de localisation d'emprunt et de rendu (diminution des « docked »)

### Question 8 : 

**Quelles stations sont les plus actives à différentes périodes de la journée ? **

Pour cette analyse, nous avons examiné comment l'activité des stations varie selon les heures de la journée. Cette question est essentielle pour comprendre les cycles d'utilisation quotidiens et optimiser la redistribution des vélos aux moments stratégiques.

Notre démarche a consisté à analyser finement la distribution horaire des départs et des arrivées. Pour cela, nous avons :

 - Extrait l'heure de départ et d'arrivée à partir des variables started_at et ended_at
 - Agrégé les données par heure et par station pour quantifier le nombre de trajets
 - Identifié les 20 stations les plus actives pour améliorer la lisibilité
 - Créé des heatmaps visualisant l'intensité d'utilisation selon l'heure
 - Filtré la période nocturne (0h-5h) pour mieux faire ressortir les tendances principales

```{r Q8, echo=FALSE, warning=FALSE}

# Extract heure
df$heure_start <- hour(ymd_hms(df$started_at))

# Agréger par heure et station de départ
df_heat <- df %>%
  group_by(start_station_name, heure_start) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 20
top_stations <- df_heat %>% 
  group_by(start_station_name) %>% 
  summarise(total = sum(nb_trajets)) %>% 
  top_n(20, total) %>% pull(start_station_name)

df_heat_top <- df_heat %>% filter(start_station_name %in% top_stations)

# Suppression NA (les autres stations apres filtre)
df_heat_top <- df_heat_top %>% filter(!is.na(start_station_name))

# Calculer l'ordre des stations par popularité
station_order <- df_heat_top %>%
  group_by(start_station_name) %>%
  summarise(total_trajets = sum(nb_trajets)) %>%
  arrange(desc(total_trajets)) %>%
  pull(start_station_name)

df_heat_top <- df_heat_top %>%
  mutate(start_station_name = factor(start_station_name, levels = station_order))

df_heat_top_filtre <- df_heat_top %>%
  filter(!(heure_start >= 0 & heure_start <= 5))

# HEATMAP filtre sur 2 a 5h du matin
ggplot(df_heat_top_filtre, aes(x = heure_start, y = reorder(start_station_name, desc(start_station_name)), fill = nb_trajets)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Stations de départ les plus actives \n dans la journée",
       x = "Heure", y = "Station", fill = "Nombre de début de trajets") +
  theme_minimal()


# Extract heure
df$heure_end <- hour(ymd_hms(df$ended_at))

# Agréger par heure et station de arrivée
df_heat <- df %>%
  group_by(end_station_name, heure_end) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 20
top_stations <- df_heat %>% 
  group_by(end_station_name) %>% 
  summarise(total = sum(nb_trajets)) %>% 
  top_n(20, total) %>% pull(end_station_name)

df_heat_top <- df_heat %>% filter(end_station_name %in% top_stations)

# Suppression NA (les autres stations apres filtre)
df_heat_top <- df_heat_top %>% filter(!is.na(end_station_name))

# Calculer l'ordre des stations par popularité
station_order <- df_heat_top %>%
  group_by(end_station_name) %>%
  summarise(total_trajets = sum(nb_trajets)) %>%
  arrange(desc(total_trajets)) %>%
  pull(end_station_name)

df_heat_top <- df_heat_top %>%
  mutate(end_station_name = factor(end_station_name, levels = station_order))

df_heat_top_filtre <- df_heat_top %>%
  filter(!(heure_end >= 0 & heure_end <= 5))

# HEATMAP filtre sur 2 a 5h du matin
ggplot(df_heat_top_filtre, aes(x = heure_end, y = reorder(end_station_name, desc(end_station_name)), fill = nb_trajets)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Stations d'arrivée les plus actives \n dans la journée",
       x = "Heure", y = "Station", fill = "Nombre de fin de trajets") +
  theme_minimal()

```
**Interprétation**

L'analyse des heatmaps représentant l'activité des stations de départ et d'arrivée en fonction de l'heure de la journée révèle des modèles d'utilisation intéressants. Les stations les plus actives varient en fonction de l'heure, avec des pics d'activité pendant les heures de pointe (7-9h et 16-18h).

L'analyse des stations révèle deux profils d'utilisation distincts. "New Hampshire Ave & T St NW", entourée de logements sans parking, présente un pic d'activité le matin pour les départs et le soir pour les arrivées, caractéristique d'un flux pendulaire marqué. "Columbus Circle/Union Station", connectée aux transports en commun, montre une utilisation dominante aux heures de pointe, liée aux horaires de travail.

À l'opposé, "Lincoln Memorial" et "Jefferson Dr & 14th St SW", situées dans un même parc touristique près d'agences gouvernementales, connaissent une activité plus étalée sur la journée, avec un pic en milieu de journée. Cette différence s'explique par leur fonction récréative/touristique versus professionnelle.

Les autres stations, comme "5th & K St NW", suivent également un schéma professionnel avec une activité concentrée autour des heures de pointe, reflétant une utilisation principalement liée aux déplacements domicile-travail.


### Question 9 : 

**Quelles sont les stations les plus utilisées le week-end, en semaine ? **

Pour cette analyse, nous avons voulu examiner comment l'utilisation des stations varie entre la semaine et le week-end. Cette question est pertinente car elle permet de distinguer les stations principalement utilisées pour les trajets domicile-travail (en semaine) de celles fréquentées pour des activités de loisirs (week-end).

Notre démarche a consisté à transformer les données temporelles pour catégoriser chaque trajet selon qu'il a lieu en semaine ou le week-end. Pour cela, nous avons :

 - Extrait le jour de la semaine à partir de la variable started_at
 - Créé une variable binaire "type_jour" (Semaine/Week-end)
 - Agrégé les données par station et par type de jour
 - Filtré les 10 stations les plus actives pour améliorer la lisibilité

```{r Q9, echo=FALSE, warning=FALSE}

# Extract jour
df$date <- ymd_hms(df$started_at)
df$jour_semaine <- wday(df$date, label = TRUE, week_start = 1) # 1 = lundi, 7 = dimanche
df$type_jour <- ifelse(df$jour_semaine %in% c("Sat", "Sun"), "Week-end", "Semaine")

# Agréger par station et type jour
df_bar <- df %>%
  group_by(start_station_name, type_jour) %>%
  summarise(nb_trajets = n(), .groups = "drop")

# TOP 10 stations
top_stations2 <- df_bar %>%
  group_by(start_station_name) %>%
  summarise(total = sum(nb_trajets)) %>%
  top_n(10, total) %>%
  pull(start_station_name)

# Filtre du TOP 10
df_bar_top <- df_bar %>% filter(start_station_name %in% top_stations2)

# Suppression NA (les autres stations apres filtre)
df_bar_top <- df_bar_top %>% filter(!is.na(start_station_name))


ggplot(df_bar_top, aes(x = reorder(start_station_name, nb_trajets), y = nb_trajets, fill = type_jour)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Stations les plus utilisées : week-end vs semaine",
       x = "Station", y = "Nombre de trajets", fill = "Jour") +
  scale_fill_manual(values = c("Week-end" = "#56B4E9", "Semaine" = "#E69F00")) +
  theme_minimal()

# STACKED BARPLOT Pourcentage
ggplot(df_bar_top, aes(x = reorder(start_station_name, nb_trajets), y = nb_trajets, fill = type_jour)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(title = "Stations les plus utilisées en % : week-end vs semaine",
       x = "Station", y = "Proportion des trajets (%)", fill = "Jour") +
  scale_fill_manual(values = c("Week-end" = "#56B4E9", "Semaine" = "#E69F00")) +
  theme_minimal()
```

**Interprétation**

L'analyse des stations révèle deux profils d'utilisation distincts. "New Hampshire Ave & T St NW", entourée de logements sans parking, génère le plus grand volume total avec des flux pendulaires marqués. "Columbus Circle/Union Station", connectée aux transports, montre une utilisation dominante en semaine (75%) liée aux horaires de travail.

À l'opposé, "Lincoln Memorial" et "Jefferson Dr & 14th St SW", situées dans un même parc touristique près d'agences gouvernementales, présentent une forte proportion d'utilisation le week-end (40-45%). Cette différence s'explique par leur fonction récréative/touristique versus professionnelle.

Les autres stations comme "5th & K St NW" suivent également un schéma professionnel avec une faible utilisation le week-end.

### Question 10 : 

**Existe-t-il des stations avec un fort déséquilibre entre départs et arrivées ?**

```{r Q10 ,warning=FALSE}

prepare_balance_data <- function(df_usage, top_n = 20) {
  df_usage %>%
    group_by(station_name) %>%
    summarise(
      total_departures = sum(pickup_counts, na.rm = TRUE),
      total_arrivals = sum(dropoff_counts, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      total_activity = total_departures + total_arrivals,
      net_difference = total_departures - total_arrivals,
      percent_imbalance = round(100 * net_difference / total_activity, 1),
      
      # Classification du déséquilibre
      balance_type = case_when(
        percent_imbalance > 15  ~ "Forte dominance\ndéparts",
        percent_imbalance > 5   ~ "Dominance\ndéparts", 
        percent_imbalance < -15 ~ "Forte dominance\narrivées",
        percent_imbalance < -5  ~ "Dominance\narrivées",
        TRUE ~ "Équilibré"
      ),
      
      # Direction du déséquilibre pour les couleurs
      balance_direction = ifelse(net_difference > 0, "Surplus départs", "Surplus arrivées")
    ) %>%
    # Filtrer les stations avec activité significative
    filter(total_activity >= 200) %>%
    # Sélectionner les plus déséquilibrées
    arrange(desc(abs(net_difference))) %>%
    head(top_n) %>%
    # Réorganiser pour le graphique (du plus déséquilibré au moins)
    mutate(
      # Raccourcir les noms longs manuellement si stringr pose problème
      station_name_short = ifelse(
        nchar(station_name) > 30,
        paste0(substr(station_name, 1, 27), "..."),
        station_name
      ),
      station_name_short = factor(station_name_short, 
                                 levels = station_name_short[order(abs(net_difference))])
    )
}

# 2. CRÉATION DU BARPLOT PRINCIPAL ----
create_balance_barplot <- function(balance_data) {
  
  # Palette de couleurs
  colors <- c("Surplus départs" = "#d73027", "Surplus arrivées" = "#1a9850")
  
  ggplot(balance_data, aes(x = reorder(station_name_display, abs(net_difference)), 
                          y = net_difference, 
                          fill = balance_direction)) +
    
    # Barres principales
    geom_col(alpha = 0.8, width = 0.7) +
    
    # Ligne de référence à zéro
    geom_hline(yintercept = 0, color = "black", size = 0.5, linetype = "solid") +
    
    # Annotations des valeurs sur les barres
    geom_text(
      aes(label = paste0(ifelse(net_difference > 0, "+", ""), 
                        format(net_difference, big.mark = " "))),
      hjust = ifelse(balance_data$net_difference > 0, -0.1, 1.1),
      size = 3,
      color = "black",
      fontface = "bold"
    ) +
    
    # Retourner le graphique (barres horizontales)
    coord_flip() +
    
    # Échelles et couleurs
    scale_fill_manual(values = colors, name = "Type de déséquilibre") +
    scale_y_continuous(
      labels = function(x) format(x, big.mark = " "),
      expand = expansion(mult = c(0.15, 0.15))
    ) +
    
    # Thème et mise en forme
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40", margin = margin(b = 20)),
      plot.caption = element_text(size = 9, color = "gray50", hjust = 1),
      
      axis.title.x = element_text(size = 11, face = "bold"),
      axis.title.y = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 9),
      
      legend.position = "bottom",
      legend.title = element_text(size = 10, face = "bold"),
      legend.text = element_text(size = 9),
      
      panel.grid.major.y = element_line(color = "gray90", size = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_line(color = "gray95", size = 0.3),
      
      plot.margin = margin(15, 15, 15, 15)
    ) +
    
    # Labels
    labs(
      title = "Stations avec le plus fort déséquilibre départs/arrivées",
      subtitle = "Différence nette entre le nombre de départs et d'arrivées par station",
      x = "Station",
      y = "Différence nette (Départs - Arrivées)",
      caption = paste("Stations avec >200 trajets • Top", nrow(balance_data))
    )
}



# Graphique principal
main_plot <- create_balance_barplot(station_balance)
print(main_plot)
```

**Interprétation**

L'analyse des déséquilibres départs/arrivées révèle une géographie fonctionnelle marquée du système Capital Bikeshare, illustrant parfaitement les flux de mobilité directionnels qui caractérisent la structure urbaine de Washington DC. Cette cartographie des asymétries dévoile deux types de stations aux rôles bien distincts : les stations "sources" génératrices de trajets et les stations "puits" d'attraction.

Les stations à surplus de départs dessinent clairement la carte des quartiers résidentiels et périphériques de la capitale. 11th & Kenyon St NW domine largement avec un excédent de 21 867 départs, suivie de près par Park Rd & Holmead Pl NW (+21 573), toutes deux situées dans les zones résidentielles du Nord-Ouest. Ces stations fonctionnent comme des "gares de départ" matinales où les résidents entament leurs trajets vers le centre-ville, créant un flux sortant massif qui nécessite un réapprovisionnement constant en vélos. L'amplitude de ces déséquilibres, dépassant les 20 000 trajets, témoigne de l'intensité des mouvements pendulaires quotidiens et de l'appropriation du vélo-partage comme solution de premier/dernier kilomètre.

À l'inverse, les stations déficitaires en départs se concentrent dans les zones d'attraction touristique et commerciale, révélant leur statut de destinations privilégiées. Georgetown Harbor / 30th St NW (-16 061) et C & O Canal & Wisconsin Ave NW (-13 901) capturent massivement les arrivées sans générer proportionnellement de départs, confirmant leur rôle de terminus pour les visiteurs découvrant le front de mer historique de Georgetown. Ces stations "puits" accumulent les vélos en fin de parcours touristique, créant un défi logistique 

### Question 11 : 

**Quels sont les trajets les plus fréquents (station de départ vers station d’arrivée) **

```{r Q11_1 ,warning=FALSE}
# 1. Calculer les trajets les plus fréquents
top_routes <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "") %>%
  
  # Créer un label pour l'axe des abscisses (trajet)
  mutate(
    trajet = paste(start_station_name, "→", end_station_name),
    # Raccourcir les noms si ils sont trop longs pour l'affichage
    trajet_court = ifelse(nchar(trajet) > 50, 
                         paste0(substr(trajet, 1, 47), "..."), 
                         trajet)
  )%>%
  
  # Grouper par paire de stations et compter les trajets
  group_by(trajet,trajet_court) %>%
  summarise(
    nombre_trajets = n(),
    .groups = 'drop'
  ) %>%
  
  # Trier par nombre de trajets décroissant
  arrange(desc(nombre_trajets)) %>%
  
  # Garder le top 10
  head(10) 

# 2. Créer le barplot
plot_top_routes <- ggplot(top_routes, aes(x = reorder(trajet_court, nombre_trajets), 
                                         y = nombre_trajets)) +
  geom_col(fill = "steelblue", alpha = 0.8) +
  
  # Centrer les nombres dans les barres
  geom_text(aes(label = scales::comma(nombre_trajets), 
                y = nombre_trajets/2),  # Position au centre de la barre
            hjust = 0.5,  # Centrer horizontalement
            vjust = 0.5,  # Centrer verticalement
            size = 3.5, 
            color = "white",  # Texte blanc pour contraster avec le bleu
            fontface = "bold") +  # Texte en gras pour plus de lisibilité
  
  # Pivoter pour avoir des labels lisibles
  coord_flip() +
  
  # Personnaliser les labels et le titre
  labs(
    title = "Top 10 des trajets les plus fréquents",
    subtitle = "Paires de stations départ → arrivée",
    x = "Trajet (Station de départ → Station d'arrivée)",
    y = "Nombre de trajets",
    caption = paste("Basé sur", scales::comma(nrow(df)), "trajets au total")
  ) +
  
  # Thème propre
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    panel.grid.minor = element_blank()
  )


# 3. Afficher le graphique
print(plot_top_routes)

```
**Interprétation**

Le classement des trajets les plus fréquents révèle un phénomène remarquable : les 10 trajets les plus populaires sont tous des trajets en boucle (même station de départ et d'arrivée), confirmant l'importance de l'usage récréatif et touristique du système Capital Bikeshare. Cette prédominance s'explique par la concentration de ces stations autour des sites emblématiques de Washington D.C., où les utilisateurs privilégient l'exploration locale plutôt que les déplacements utilitaires.

Jefferson Dr & 14th St SW domine largement avec 19 785 trajets, représentant 0,12% du trafic total, suivi de très près par Smithsonian-National Mall avec 18 657 trajets. Ces deux destinations phares du National Mall captent à elles seules près de 38 500 trajets en boucle, démontrant leur statut exceptionnel dans l'écosystème touristique de la capitale. Le groupe suivant se structure autour de trois destinations majeures (4th St & Madison Dr NW, Gravelly Point, Lincoln Memorial) oscillant entre 12 725 et 14 807 trajets, révélant une hiérarchie claire dans l'attractivité des sites patrimoniaux et récréatifs.

Le bas du classement (stations 6 à 10) maintient des volumes substantiels entre 9 785 et 11 777 trajets, confirmant que même les destinations "moins populaires" du top 10 génèrent un trafic récréatif considérable. Cette répartition démontre que Capital Bikeshare a réussi à créer un réseau de loisirs urbains performant, où chaque station fonctionne comme un hub autonome d'exploration locale. La structure tarifaire favorisant les trajets de moins de 45 minutes encourage ces usages en boucle, transformant le système en une véritable plateforme de découverte touristique tout en maintenant un modèle économique viable.

Cette prédominance des trajets en boucle masque cependant une réalité importante des déplacements effectifs. Si nous excluons ces trajets circulaires pour nous concentrer uniquement sur les véritables déplacements d'un point A vers un point B, un paysage très différent émerge

**Top 10 des trajets point-à-point (trajets différents)**

```{r Q11_2,warning=FALSE}
# 1. Calculer les trajets les plus fréquents
top_routes <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" & end_station_name != start_station_name) %>%
  
  # Grouper par paire de stations et compter les trajets
  group_by(start_station_name, end_station_name) %>%
  summarise(
    nombre_trajets = n(),
    .groups = 'drop'
  ) %>%
  
  # Trier par nombre de trajets décroissant
  arrange(desc(nombre_trajets)) %>%
  
  # Garder le top 10
  head(10) %>%
  
  # Créer un label pour l'axe des abscisses (trajet)
  mutate(
    trajet = paste(start_station_name, "→", end_station_name),
    # Raccourcir les noms si ils sont trop longs pour l'affichage
    trajet_court = ifelse(nchar(trajet) > 50, 
                         paste0(substr(trajet, 1, 47), "..."), 
                         trajet)
  )

# 2. Créer le barplot
plot_top_routes <- ggplot(top_routes, aes(x = reorder(trajet_court, nombre_trajets), 
                                         y = nombre_trajets)) +
  geom_col(fill = "steelblue", alpha = 0.8) +
  
  # Centrer les nombres dans les barres
  geom_text(aes(label = scales::comma(nombre_trajets), 
                y = nombre_trajets/2),  # Position au centre de la barre
            hjust = 0.5,  # Centrer horizontalement
            vjust = 0.5,  # Centrer verticalement
            size = 3.5, 
            color = "white",  # Texte blanc pour contraster avec le bleu
            fontface = "bold") +  # Texte en gras pour plus de lisibilité
  
  # Pivoter pour avoir des labels lisibles
  coord_flip() +
  
  # Personnaliser les labels et le titre
  labs(
    title = "Top 10 des trajets les plus fréquents",
    subtitle = "Paires de stations départ → arrivée",
    x = "Trajet (Station de départ → Station d'arrivée)",
    y = "Nombre de trajets",
    caption = paste("Basé sur", scales::comma(nrow(df)), "trajets au total")
  ) +
  
  # Thème propre
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    panel.grid.minor = element_blank()
  )

# 3. Afficher le graphique
print(plot_top_routes)
```

**Interprétation**

Le classement des trajets point-à-point révèle un paysage beaucoup plus diversifié que les trajets en boucle, mettant en évidence deux logiques d'usage distinctes : les déplacements utilitaires urbains et les circuits touristiques inter-monuments. Cette analyse dévoile les véritables flux de mobilité du système Capital Bikeshare lorsque les utilisateurs se déplacent effectivement d'un point A vers un point B.

Columbus Circle / Union Station emerge comme un hub de transit majeur, dominant 4 des 10 trajets les plus fréquents avec des connexions bidirectionnelles vers 8th & F St NE (9 603 et 8 206 trajets) et 6th & H St NE (8 697 et 6 578 trajets). Cette prédominance s'explique par le statut de Union Station comme principale gare ferroviaire de Washington, créant un effet d'attraction naturel pour les correspondances multimodales vers les quartiers résidentiels et professionnels du nord-est. Les volumes légèrement asymétriques entre les sens aller-retour suggèrent des patterns de mobilité pendulaire avec des pointes directionnelles selon les heures.

Le triangle touristique Lincoln Memorial - Jefferson Memorial - Jefferson Dr & 14th St SW constitue le second cluster dominant avec 6 trajets représentant plus de 38 000 déplacements cumulés. Le trajet Lincoln Memorial → Jefferson Memorial (8 941 trajets) domine cette catégorie, révélant un circuit patrimonial privilégié par les visiteurs souhaitant relier les deux mémoriaux iconiques en 15-20 minutes de vélo. La réciprocité quasi-parfaite des flux (8 196 et 8 177 trajets entre Lincoln Memorial et Jefferson Dr & 14th St SW) confirme l'existence de parcours touristiques structurés où le vélo devient l'outil optimal pour découvrir l'ensemble monumental de la capitale américaine.

Maintenant que nous avons identifié la nature particulière des trajets en boucle, analysons plus précisément leurs caractéristiques temporelles pour comprendre les comportements d'usage qui les motivent

**Distribution des temps de trajet" (en pourcentages)** \n
Distribution du temps de trajet pour les trajets ayant le meme point de depart et d'arriver
https://capitalbikeshare.com/pricing

```{r Q11_3,warning=FALSE}

# 1. Préparer les données des trajets aller-retour
same_station_duration_data <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" &
         !is.na(started_at) & !is.na(ended_at)) %>%
  
  # Calculer la durée du trajet en minutes
  mutate(
    duration_minutes = as.numeric(difftime(ended_at, started_at, units = "mins")),
    is_same_station = (start_station_name == end_station_name)
  ) %>%
  
  # Garder seulement les trajets aller-retour
  filter(is_same_station == TRUE) %>%
  
  # Filtrer les durées aberrantes (entre 1 minute et 8 heures)
  filter(duration_minutes >= 1 & duration_minutes <= 480)

# 2. Créer les données pour le graphique en ligne (intervalles de 5 minutes)
line_data <- same_station_duration_data %>%
  mutate(
    # Grouper par intervalles de 5 minutes
    duration_interval = floor(duration_minutes / 5) * 5
  ) %>%
  count(duration_interval) %>%
  mutate(
    duration_label = paste0(duration_interval, "-", duration_interval + 5, " min"),
    percentage = round(100 * n / sum(n), 2),
    cumulative_count = cumsum(n),
    cumulative_percentage = round(100 * cumulative_count / sum(n), 1)
  ) %>%
  # Garder seulement les intervalles avec au moins quelques trajets pour la lisibilité
  filter(duration_interval <= 150) %>%  # Jusqu'à 150 minutes pour la lisibilité
  # Garder seulement les intervalles avec au moins quelques trajets pour la lisibilité
  filter(10<=duration_interval)  # Jusqu'à 150 minutes pour la lisibilité

# 4. Graphique en ligne - Pourcentages
plot_line_percentage <- ggplot(line_data, aes(x = duration_interval, y = percentage)) +
  
  geom_line(color = "darkgreen", size = 1.2) +
  geom_point(color = "darkgreen", size = 2) +
  
  # Zones colorées selon les catégories
  geom_area(data = filter(line_data, duration_interval <= 45), 
            aes(x = duration_interval, y = percentage), 
            fill = "#2E7D32", alpha = 0.3) +
  geom_area(data = filter(line_data, duration_interval > 45 & duration_interval <= 75), 
            aes(x = duration_interval, y = percentage), 
            fill = "#FF9800", alpha = 0.3) +
  geom_area(data = filter(line_data, duration_interval > 75), 
            aes(x = duration_interval, y = percentage), 
            fill = "#D32F2F", alpha = 0.3) +
  
  # Remettre la ligne par-dessus
  geom_line(color = "darkgreen", size = 1.2) +
  geom_point(color = "darkgreen", size = 2) +
  
  # Lignes verticales
  geom_vline(xintercept = 45, color = "orange", linetype = "dashed", size = 1) +
  geom_vline(xintercept = 75, color = "red", linetype = "dashed", size = 1) +
  
  labs(
    title = "Distribution des temps de trajet (en pourcentages)",
    subtitle = "Zones colorées : Vert (≤45min), Orange (45-75min), Rouge (>75min)",
    x = "Durée (minutes)",
    y = "Pourcentage des trajets (%)",
    caption = "Intervalles de 5 minutes"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold")
  )

print(plot_line_percentage)

# 7. Statistiques pour les points clés
cat("=== Points clés de la distribution ===\n")

# Trouver les pics de la distribution
peak_interval <- line_data[which.max(line_data$n), ]
cat("Pic principal:", peak_interval$duration_interval, "-", peak_interval$duration_interval + 5, 
    "minutes (", peak_interval$n, "trajets,", peak_interval$percentage, "%)\n")

# Statistiques aux seuils
seuil_45 <- line_data %>% filter(duration_interval <= 45) %>% summarise(total = sum(percentage))
seuil_75 <- line_data %>% filter(duration_interval <= 75) %>% summarise(total = sum(percentage))

cat("Trajets ≤ 45min:", round(seuil_45$total, 1), "%\n")
cat("Trajets ≤ 75min:", round(seuil_75$total, 1), "%\n")

```

**Interprétation**

La distribution des temps de trajet pour les trajets en boucle (même station de départ et d'arrivée) révèle des comportements d'usage particuliers fortement influencés par la structure tarifaire de Capital Bikeshare. On observe une concentration majeure des trajets dans la zone verte (≤45 minutes), correspondant à la période gratuite pour les abonnés journaliers et annuels, ce qui suggère que de nombreux utilisateurs planifient délibérément leurs sorties récréatives, sportives ou touristiques pour rester dans cette fenêtre sans frais supplémentaires.

La diminution progressive dans la zone orange (45-75 minutes) s'explique par l'introduction des frais de 0,05$/minute pour les vélos classiques, incitant les utilisateurs à raccourcir leurs balades ou à accepter un coût modéré pour des activités de loisir plus longues. Cette baisse devient encore plus marquée dans la zone rouge (>75 minutes), où les coûts cumulés deviennent dissuasifs pour la plupart des utilisateurs occasionnels.

Ces trajets en boucle reflètent principalement des usages de loisir, d'exercice physique ou de découverte touristique plutôt que des déplacements utilitaires. L'émergence des vélos électriques depuis 2023, malgré leur coût supérieur (0,10-0,15$/minute), peut expliquer une partie des trajets plus longs car ils permettent d'explorer des distances plus importantes avec moins d'effort, rendant les balades étendues plus accessibles à un public plus large, y compris aux utilisateurs moins sportifs.

Cette distribution globale des temps cache des variations importantes selon les stations. En détaillant la répartition des durées pour chaque station pratiquant des trajets en boucle, nous pouvons identifier des profils d'usage spécifiques

**Répartition détaillée des durées par station**

```{r Q11_4,warning=FALSE}

library(dplyr)
library(ggplot2)
library(lubridate)

# 1. Calculer les statistiques avec 3 catégories de durée
same_station_rides <- df %>%
  # Filtrer les lignes avec des noms de stations valides
  filter(!is.na(start_station_name) & !is.na(end_station_name) & 
         start_station_name != "" & end_station_name != "" &
         !is.na(started_at) & !is.na(ended_at)) %>%
  
  # Calculer la durée du trajet en minutes
  mutate(
    duration_minutes = as.numeric(difftime(ended_at, started_at, units = "mins")),
    is_same_station = (start_station_name == end_station_name)
  ) %>%
  
  # Filtrer les durées aberrantes (moins de 1 min ou plus de 8h)
  filter(duration_minutes > 1 & duration_minutes < 480) %>%
  
  # Garder seulement les trajets aller-retour
  filter(is_same_station == TRUE) %>%
  
  # Grouper par station et calculer les statistiques avec 3 catégories
  group_by(start_station_name) %>%
  summarise(
    nombre_trajets_meme_station = n(),
    trajets_45min_moins = sum(duration_minutes <= 45),
    trajets_45min_75min = sum(duration_minutes > 45 & duration_minutes <= 75),
    trajets_75min_plus = sum(duration_minutes > 75),
    
    proportion_45min_moins = round(100 * trajets_45min_moins / n(), 1),
    proportion_45min_75min = round(100 * trajets_45min_75min / n(), 1),
    proportion_75min_plus = round(100 * trajets_75min_plus / n(), 1),
    
    duree_moyenne_minutes = round(mean(duration_minutes, na.rm = TRUE), 1),
    .groups = 'drop'
  ) %>%
  
  # Filtrer les stations avec au moins 10 trajets
  filter(nombre_trajets_meme_station >= 10) %>%
  
  # Trier et garder le top 15
  arrange(desc(nombre_trajets_meme_station)) %>%
  head(15) %>%
  
  # Raccourcir les noms de stations si nécessaire
  mutate(
    station_short = ifelse(nchar(start_station_name) > 30, 
                          paste0(substr(start_station_name, 1, 27), "..."), 
                          start_station_name),
    
    # Créer une catégorie dominante pour la couleur
    dominant_category = case_when(
      proportion_45min_moins >= 50 ~ "Majorité ≤45min",
      proportion_45min_75min >= 40 ~ "Beaucoup 45-75min", 
      proportion_75min_plus >= 30 ~ "Beaucoup >75min",
      TRUE ~ "Mixte"
    ),
    
    # Factoriser pour contrôler l'ordre
    dominant_category = factor(dominant_category, 
                             levels = c("Majorité ≤45min", "Beaucoup 45-75min", 
                                       "Beaucoup >75min", "Mixte"))
  )

# 3. Graphique en barres empilées pour montrer la répartition exacte
library(tidyr)

# Préparer les données pour le graphique empilé
stacked_data <- same_station_rides %>%
  select(station_short, nombre_trajets_meme_station, 
         trajets_45min_moins, trajets_45min_75min, trajets_75min_plus) %>%
  pivot_longer(cols = c(trajets_45min_moins, trajets_45min_75min, trajets_75min_plus),
               names_to = "categorie_duree", 
               values_to = "nombre_trajets") %>%
  mutate(
    categorie_label = case_when(
      categorie_duree == "trajets_45min_moins" ~ "≤45 min",
      categorie_duree == "trajets_45min_75min" ~ "45-75 min", 
      categorie_duree == "trajets_75min_plus" ~ ">75 min"
    ),
    categorie_label = factor(categorie_label, levels = c("≤45 min", "45-75 min", ">75 min"))
  )

plot_stacked <- ggplot(stacked_data, 
                      aes(x = reorder(station_short, nombre_trajets_meme_station), 
                          y = nombre_trajets, 
                          fill = categorie_label)) +
  
  geom_col(position = "stack", alpha = 0.8) +
  
  coord_flip() +
  
  scale_fill_manual(
    values = c("≤45 min" = "#2E7D32",      # Vert
               "45-75 min" = "#FF9800",    # Orange  
               ">75 min" = "#D32F2F")      # Rouge
  ) +
  
  labs(
    title = "Répartition détaillée des durées par station",
    subtitle = "Barres empilées montrant la distribution exacte",
    x = "Station",
    y = "Nombre de trajets",
    fill = "Durée du trajet"
  ) +
  
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )

print(plot_stacked)

# 4. Statistiques globales pour les 3 catégories
cat("=== Analyse des 3 catégories de durée ===\n")

global_stats <- same_station_rides %>%
  summarise(
    total_trajets = sum(nombre_trajets_meme_station),
    total_45min_moins = sum(trajets_45min_moins),
    total_45min_75min = sum(trajets_45min_75min),
    total_75min_plus = sum(trajets_75min_plus),
    
    prop_45min_moins = round(100 * total_45min_moins / total_trajets, 1),
    prop_45min_75min = round(100 * total_45min_75min / total_trajets, 1),
    prop_75min_plus = round(100 * total_75min_plus / total_trajets, 1)
  )

cat("Total trajets aller-retour:", global_stats$total_trajets, "\n")
cat("≤45min:", global_stats$total_45min_moins, "(", global_stats$prop_45min_moins, "%)\n")
cat("45-75min:", global_stats$total_45min_75min, "(", global_stats$prop_45min_75min, "%)\n") 
cat(">75min:", global_stats$total_75min_plus, "(", global_stats$prop_75min_plus, "%)\n")



```

**Interprétation**

La répartition des durées de trajets en boucle par station révèle des profils d'usage distincts liés à la vocation géographique et touristique de chaque localisation. Les stations les plus populaires pour les trajets circulaires se concentrent autour de sites emblématiques de Washington D.C., avec Jefferson Dr & 14th St SW et Smithsonian-National Mall en tête, confirmant l'usage majoritairement récréatif et touristique de ce type de trajet.

On observe une prédominance systématique des trajets courts (≤45 minutes, zone verte) dans toutes les stations, reflétant l'influence de la structure tarifaire gratuite pour les abonnés dans cette tranche. Cependant, certaines stations comme Jefferson Dr & 14th St SW, Smithsonian-National Mall, et Gravelly Point présentent des proportions plus importantes de trajets moyens et longs (zones orange et rouge), suggérant que ces emplacements favorisent des activités de loisir plus étendues malgré les coûts supplémentaires.

Les stations situées près de sites naturels ou panoramiques (Gravelly Point, Roosevelt Island, National Harbor Carousel) montrent des durées plus variées, indiquant que les utilisateurs sont disposés à payer des frais additionnels pour profiter pleinement de ses environnements particuliers. À l'inverse, les stations plus urbaines et centrales (15th St & Pennsylvania Ave NW, Jefferson Memorial) présentent une concentration plus marquée dans la zone gratuite, suggérant un usage plus utilitaire ou des contraintes budgétaires plus strictes pour ces localisations.



